<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时速度显示</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }

        .measurement {
            font-size: 1.5em;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>实时速度显示 (≧∇≦)/</h1>
    <div class="measurement" id="velocity-x">X 方向速度: 0 m/s</div>
    <div class="measurement" id="velocity-y">Y 方向速度: 0 m/s</div>
    <div class="measurement" id="velocity-z">Z 方向速度: 0 m/s</div>
    <button id="request-permission">请求加速度权限</button>

    <script>
        let lastTimestamp;
        let velocity = { x: 0, y: 0, z: 0 };
        const threshold = 0.1; // 静止阈值
        const damping = 0.9; // 阻尼系数，用于低通滤波

        function handleMotionEvent(event) {
            let acc = event.acceleration;
            if (!acc || (acc.x === null && acc.y === null && acc.z === null)) {
                acc = event.accelerationIncludingGravity;
            }

            let currentTimestamp = event.timeStamp;
            if (lastTimestamp) {
                let deltaTime = (currentTimestamp - lastTimestamp) / 1000; // 将时间差转换为秒

                // 低通滤波
                velocity.x = damping * velocity.x + (1 - damping) * ((acc.x || 0) * deltaTime);
                velocity.y = damping * velocity.y + (1 - damping) * ((acc.y || 0) * deltaTime);
                velocity.z = damping * velocity.z + (1 - damping) * ((acc.z || 0) * deltaTime);

                // 更新速度
                velocity.x += (acc.x || 0) * deltaTime;
                velocity.y += (acc.y || 0) * deltaTime;
                velocity.z += (acc.z || 0) * deltaTime;

                // 如果加速度接近零，认为设备静止，重置速度
                // if (Math.abs(acc.x) < threshold) velocity.x = 0;
                // if (Math.abs(acc.y) < threshold) velocity.y = 0;
                // if (Math.abs(acc.z) < threshold) velocity.z = 0;

                document.getElementById('velocity-x').textContent = 'X 方向速度: ' + velocity.x.toFixed(2) + ' m/s';
                document.getElementById('velocity-y').textContent = 'Y 方向速度: ' + velocity.y.toFixed(2) + ' m/s';
                document.getElementById('velocity-z').textContent = 'Z 方向速度: ' + velocity.z.toFixed(2) + ' m/s';
            }
            lastTimestamp = currentTimestamp;
        }

        document.getElementById('request-permission').addEventListener('click', function () {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(function (permissionState) {
                        if (permissionState === 'granted') {
                            window.addEventListener('devicemotion', handleMotionEvent);
                            document.getElementById('request-permission').style.display = 'none';
                        } else {
                            alert('加速度权限被拒绝了哦~ (>_<)');
                        }
                    })
                    .catch(console.error);
            } else {
                alert('您的设备不支持权限请求哦~ (>_<)');
            }
        });
    </script>
</body>

</html>