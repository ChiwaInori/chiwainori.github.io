<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>军舰大战 - ChiwaInori.top</title>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/type-center.css" />
    <style>
        :root {
            --minor: #ff0077;
        }

        div#rules *, div#chooseMode *, div#mainPanel * {
            text-align: center; 
            margin-left: 0px;
        }

        #statusTitle, #chooseMode > h2 {
            margin-top: 32px;
        }

        #subtitle {
            margin-bottom: 32px;
        }

        .leftTable { 
            margin: auto auto auto 9.5% !important;
        }

        .actionButton {
            margin-bottom: -3px;
            margin-left: -1px;
        }

        #status-1 {
            margin: auto auto auto -45% !important;
        }

        #status-2 {
            margin: -93px auto auto 50% !important;
        }

        table button {
            margin-right: 0px;
        }

        .online-confirm {
            margin-left: 16px;
        }

        #onlineFinish {
            margin-top: 32px;
        }

        @media screen and (min-width: 700px) {
            .leftTable { 
                margin: auto auto auto 29.5% !important;
            }

            #status-1 {
                margin: auto auto auto -30.5% !important;
            }

            #status-2 {
                margin: -93px auto auto 34% !important;
            }
        }
    </style>
    <script src="/chiwa-functions.js"></script>
</head>

<body><div class="IFB-Green"><p><strong>此页有更新版本</strong></p><p>这表示此页不再被使用. 你应该前往更新页面. 请点击导航栏中 @ 前面的链接.</p></div><div id="cw-main">
    <div id="cw-title">
        <h1 style="text-align: center; margin-left: 0px;">军舰大战</h1>
    </div>
    <div id="cw-nav"><h6>&nbsp;</h6></div>
    <div id="cw-content">
        <div id="rules">
            <p>欢迎体验 ChiwaInori.top 的 军舰大战 小游戏!</p>
            <p class="STX">本小游戏已于 2025.7.11 完全重写代码并添加部分新功能. 请于 chiwainori@outlook.com 反馈 Bug. 感谢您的体验!</p>
            <br />
            <h2>游戏规则</h2>
            <p>在游戏开始时, 两个玩家都会有一个 6*6 的显示盘 (&quot;(D)&quot;, Display), 并且需要在屏幕中间放置隔板等方式, 让双方互相<strong>看不到对方的棋盘</strong>. 你的棋盘下面还会有一个 6x6 的控制板 (&quot;(O)&quot;, Operation).</p>
            <p>双方需要选择一个方格作为自己的<strong>母舰</strong>的位置, 通过<strong>按下控制盘上对应的按钮</strong>来进行.</p>
            <br />
            <p>随后, 先手玩家<strong>选择一个空格放置自己新的战列舰, 然后选择一个敌方的位置来进行打击</strong>. 然后, 后手玩家进行同样的操作, 以此循环.</p>
            <p>如果自己的母舰被摧毁, 那么就<strong>无法放置更多的战列舰</strong>. 此时被摧毁母舰的玩家在击中敌方军舰后可以<strong>连续攻击, 直至打空</strong>, 打空后轮到另一个玩家进行操作.</p>
            <p>把对方的所有军舰全部击毁即胜利.</p>
            <br />
            <p><input id="option-showSuggestion" type="checkbox" checked /><strong>标记已攻击位置</strong> - <span id="description-showSuggestion"><strong>攻击过</strong>的位置会有 <strong id="description-showSuggestion-1" style="color: var(--minor);">粉色感叹号 (!)</strong> 标记.</span></p>
            <p><input id="option-showOffset" type="checkbox" checked /><strong>打空时获取敌方最近军舰距离</strong> - <span id="description-showOffset">当你<strong>打空</strong>时, 你可以获取打击地点与敌方<strong>最近的一艘军舰</strong>的<ruby>曼哈顿距离<rt>d = |x1-x2|+|y1-y2|</rt></ruby>.</span></p>
            <p id="description-showOffsetSuggestion" class="STX" style="margin-top: -10px;"><input id="option-showOffsetSuggestion" type="checkbox" checked /><strong>根据最近军舰距离标记攻击位置</strong> - <span id="description-showOffsetSuggestion-1">下次攻击时, 可能有敌方军舰的位置会有 <strong id="description-showOffsetSuggestion-2" style="color: var(--lightOrange);">亮橙色</strong> 标记.</span></p>
            <br />
            <p style="margin-left: 20%;"><button onclick="nextPage()">点击开始</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(或 <input id="saveInput" type="file" accept=".json" />)</p>
            <p id="saveText" style="font-size: 10px;">若选择读取游戏, 请在选择存档文件后点击 &quot;点击开始&quot; 按钮.</p>
            <br /><br />
            <h6 style="color: var(--gray)">ChiwaInori.top ShipWar v<span id="version"></span>. 本游戏的灵感与本网站所有代码均为 <ruby>千和<rt>ちわ</rt></ruby> いのり 所作。<span id="copyright" style="color: var(--gray)"></span></h6>
        </div>
        <div id="chooseMode" hidden>
            <h2>选择游戏模式</h2>
            <br /><br />
            <h3>本地对战</h3>
            <p style="position: relative; left: 0%;"><button onclick="singlePlayer(1)">左侧先手</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="singlePlayer(0)">随机先手</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="singlePlayer(2)">右侧先手</button></p>
            <br />
            <h3>单人游戏</h3>
            <p style="position: relative; left: 0%;"><button onclick="startRobot(1)">玩家先手</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="startRobot(0)">随机先手</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="startRobot(2)">人机先手</button></p>
            <br />
            <h3>联机模式</h3>
            <p>如需游玩此联机模式, 请循环遵循以下步骤.</p>
            <p>1. 你在你的电脑上进行操作, 包括放置战列舰、选择攻击位置</p>
            <p>2. 此网页将会根据你的操作生成一段代码, 你需要把这串代码发送给你的好友</p>
            <p>3. 你的好友在他的电脑上输入代码, 通过读取代码来知道你的操作</p>
            <p>4. 你的好友完成他的操作后, 将代码发送给你, 你输入代码后继续你的操作</p>
            <p><button onclick="multiplayer(1)">我方先手</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="multiplayer(0)">随机先手</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="multiplayer(2)">好友先手</button></p>
            <p>好友已准备好? 请输入代码: <input id="joinMultiplayerCode" style="width: 50px;" /><button id="joinMultiplayerButton" onclick="joinMultiplayer(2)" style="margin-left: 16px;" disabled>确认</button></p>
            <p id="wrongCode" style="color: var(--red); font-size: 10px;"></p>
        </div>
        <div id="mainPanel" hidden>
            <h2 id="statusTitle"></h2>
            <h6 id="subtitle"></h6>
            <table id="table-1-d" class="BRT leftTable">
                <tr><th>(D)</th><th>&nbsp;A&nbsp;</th><th>&nbsp;B&nbsp;</th><th>&nbsp;C&nbsp;</th><th>&nbsp;D&nbsp;</th><th>&nbsp;E&nbsp;</th><th>&nbsp;F&nbsp;</th></tr>
                <tr><th>1</th><th id="display-1-1">&nbsp;</th><th id="display-1-2">&nbsp;</th><th id="display-1-3">&nbsp;</th><th id="display-1-4">&nbsp;</th><th id="display-1-5">&nbsp;</th><th id="display-1-6">&nbsp;</th></tr>
                <tr><th>2</th><th id="display-1-7">&nbsp;</th><th id="display-1-8">&nbsp;</th><th id="display-1-9">&nbsp;</th><th id="display-1-10">&nbsp;</th><th id="display-1-11">&nbsp;</th><th id="display-1-12">&nbsp;</th></tr>
                <tr><th>3</th><th id="display-1-13">&nbsp;</th><th id="display-1-14">&nbsp;</th><th id="display-1-15">&nbsp;</th><th id="display-1-16">&nbsp;</th><th id="display-1-17">&nbsp;</th><th id="display-1-18">&nbsp;</th></tr>
                <tr><th>4</th><th id="display-1-19">&nbsp;</th><th id="display-1-20">&nbsp;</th><th id="display-1-21">&nbsp;</th><th id="display-1-22">&nbsp;</th><th id="display-1-23">&nbsp;</th><th id="display-1-24">&nbsp;</th></tr>
                <tr><th>5</th><th id="display-1-25">&nbsp;</th><th id="display-1-26">&nbsp;</th><th id="display-1-27">&nbsp;</th><th id="display-1-28">&nbsp;</th><th id="display-1-29">&nbsp;</th><th id="display-1-30">&nbsp;</th></tr>
                <tr><th>6</th><th id="display-1-31">&nbsp;</th><th id="display-1-32">&nbsp;</th><th id="display-1-33">&nbsp;</th><th id="display-1-34">&nbsp;</th><th id="display-1-35">&nbsp;</th><th id="display-1-36">&nbsp;</th></tr>
            </table>
            <table id="table-2-d" class="BRT" style="margin: -177px auto auto 61.5%">
                <tr><th>(D)</th><th>&nbsp;A&nbsp;</th><th>&nbsp;B&nbsp;</th><th>&nbsp;C&nbsp;</th><th>&nbsp;D&nbsp;</th><th>&nbsp;E&nbsp;</th><th>&nbsp;F&nbsp;</th></tr>
                <tr><th>1</th><th id="display-2-1">&nbsp;</th><th id="display-2-2">&nbsp;</th><th id="display-2-3">&nbsp;</th><th id="display-2-4">&nbsp;</th><th id="display-2-5">&nbsp;</th><th id="display-2-6">&nbsp;</th></tr>
                <tr><th>2</th><th id="display-2-7">&nbsp;</th><th id="display-2-8">&nbsp;</th><th id="display-2-9">&nbsp;</th><th id="display-2-10">&nbsp;</th><th id="display-2-11">&nbsp;</th><th id="display-2-12">&nbsp;</th></tr>
                <tr><th>3</th><th id="display-2-13">&nbsp;</th><th id="display-2-14">&nbsp;</th><th id="display-2-15">&nbsp;</th><th id="display-2-16">&nbsp;</th><th id="display-2-17">&nbsp;</th><th id="display-2-18">&nbsp;</th></tr>
                <tr><th>4</th><th id="display-2-19">&nbsp;</th><th id="display-2-20">&nbsp;</th><th id="display-2-21">&nbsp;</th><th id="display-2-22">&nbsp;</th><th id="display-2-23">&nbsp;</th><th id="display-2-24">&nbsp;</th></tr>
                <tr><th>5</th><th id="display-2-25">&nbsp;</th><th id="display-2-26">&nbsp;</th><th id="display-2-27">&nbsp;</th><th id="display-2-28">&nbsp;</th><th id="display-2-29">&nbsp;</th><th id="display-2-30">&nbsp;</th></tr>
                <tr><th>6</th><th id="display-2-31">&nbsp;</th><th id="display-2-32">&nbsp;</th><th id="display-2-33">&nbsp;</th><th id="display-2-34">&nbsp;</th><th id="display-2-35">&nbsp;</th><th id="display-2-36">&nbsp;</th></tr>
            </table>
            <br />
            <table id="table-1-o" class="BRT leftTable">
                <tr><th>(O)</th><th>&nbsp;A&nbsp;</th><th>&nbsp;B&nbsp;</th><th>&nbsp;C&nbsp;</th><th>&nbsp;D&nbsp;</th><th>&nbsp;E&nbsp;</th><th>&nbsp;F&nbsp;</th></tr>
                <tr>
                    <th>1</th>
                    <th><button id="button-1-1" class="actionButton button-1" onclick="action(1, 1)">&nbsp;</button></th>
                    <th><button id="button-1-2" class="actionButton button-1" onclick="action(1, 2)">&nbsp;</button></th>
                    <th><button id="button-1-3" class="actionButton button-1" onclick="action(1, 3)">&nbsp;</button></th>
                    <th><button id="button-1-4" class="actionButton button-1" onclick="action(1, 4)">&nbsp;</button></th>
                    <th><button id="button-1-5" class="actionButton button-1" onclick="action(1, 5)">&nbsp;</button></th>
                    <th><button id="button-1-6" class="actionButton button-1" onclick="action(1, 6)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>2</th>
                    <th><button id="button-1-7" class="actionButton button-1" onclick="action(1, 7)">&nbsp;</button></th>
                    <th><button id="button-1-8" class="actionButton button-1" onclick="action(1, 8)">&nbsp;</button></th>
                    <th><button id="button-1-9" class="actionButton button-1" onclick="action(1, 9)">&nbsp;</button></th>
                    <th><button id="button-1-10" class="actionButton button-1" onclick="action(1, 10)">&nbsp;</button></th>
                    <th><button id="button-1-11" class="actionButton button-1" onclick="action(1, 11)">&nbsp;</button></th>
                    <th><button id="button-1-12" class="actionButton button-1" onclick="action(1, 12)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>3</th>
                    <th><button id="button-1-13" class="actionButton button-1" onclick="action(1, 13)">&nbsp;</button></th>
                    <th><button id="button-1-14" class="actionButton button-1" onclick="action(1, 14)">&nbsp;</button></th>
                    <th><button id="button-1-15" class="actionButton button-1" onclick="action(1, 15)">&nbsp;</button></th>
                    <th><button id="button-1-16" class="actionButton button-1" onclick="action(1, 16)">&nbsp;</button></th>
                    <th><button id="button-1-17" class="actionButton button-1" onclick="action(1, 17)">&nbsp;</button></th>
                    <th><button id="button-1-18" class="actionButton button-1" onclick="action(1, 18)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>4</th>
                    <th><button id="button-1-19" class="actionButton button-1" onclick="action(1, 19)">&nbsp;</button></th>
                    <th><button id="button-1-20" class="actionButton button-1" onclick="action(1, 20)">&nbsp;</button></th>
                    <th><button id="button-1-21" class="actionButton button-1" onclick="action(1, 21)">&nbsp;</button></th>
                    <th><button id="button-1-22" class="actionButton button-1" onclick="action(1, 22)">&nbsp;</button></th>
                    <th><button id="button-1-23" class="actionButton button-1" onclick="action(1, 23)">&nbsp;</button></th>
                    <th><button id="button-1-24" class="actionButton button-1" onclick="action(1, 24)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>5</th>
                    <th><button id="button-1-25" class="actionButton button-1" onclick="action(1, 25)">&nbsp;</button></th>
                    <th><button id="button-1-26" class="actionButton button-1" onclick="action(1, 26)">&nbsp;</button></th>
                    <th><button id="button-1-27" class="actionButton button-1" onclick="action(1, 27)">&nbsp;</button></th>
                    <th><button id="button-1-28" class="actionButton button-1" onclick="action(1, 28)">&nbsp;</button></th>
                    <th><button id="button-1-29" class="actionButton button-1" onclick="action(1, 29)">&nbsp;</button></th>
                    <th><button id="button-1-30" class="actionButton button-1" onclick="action(1, 30)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>6</th>
                    <th><button id="button-1-31" class="actionButton button-1" onclick="action(1, 31)">&nbsp;</button></th>
                    <th><button id="button-1-32" class="actionButton button-1" onclick="action(1, 32)">&nbsp;</button></th>
                    <th><button id="button-1-33" class="actionButton button-1" onclick="action(1, 33)">&nbsp;</button></th>
                    <th><button id="button-1-34" class="actionButton button-1" onclick="action(1, 34)">&nbsp;</button></th>
                    <th><button id="button-1-35" class="actionButton button-1" onclick="action(1, 35)">&nbsp;</button></th>
                    <th><button id="button-1-36" class="actionButton button-1" onclick="action(1, 36)">&nbsp;</button></th>
                </tr>
            </table>
            <table id="table-2-o" class="BRT" style="margin: -195px auto auto 61.5%;">
                <tr><th>(O)</th><th>&nbsp;A&nbsp;</th><th>&nbsp;B&nbsp;</th><th>&nbsp;C&nbsp;</th><th>&nbsp;D&nbsp;</th><th>&nbsp;E&nbsp;</th><th>&nbsp;F&nbsp;</th></tr>
                <tr>
                    <th>1</th>
                    <th><button id="button-2-1" class="actionButton button-2" onclick="action(2, 1)">&nbsp;</button></th>
                    <th><button id="button-2-2" class="actionButton button-2" onclick="action(2, 2)">&nbsp;</button></th>
                    <th><button id="button-2-3" class="actionButton button-2" onclick="action(2, 3)">&nbsp;</button></th>
                    <th><button id="button-2-4" class="actionButton button-2" onclick="action(2, 4)">&nbsp;</button></th>
                    <th><button id="button-2-5" class="actionButton button-2" onclick="action(2, 5)">&nbsp;</button></th>
                    <th><button id="button-2-6" class="actionButton button-2" onclick="action(2, 6)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>2</th>
                    <th><button id="button-2-7" class="actionButton button-2" onclick="action(2, 7)">&nbsp;</button></th>
                    <th><button id="button-2-8" class="actionButton button-2" onclick="action(2, 8)">&nbsp;</button></th>
                    <th><button id="button-2-9" class="actionButton button-2" onclick="action(2, 9)">&nbsp;</button></th>
                    <th><button id="button-2-10" class="actionButton button-2" onclick="action(2, 10)">&nbsp;</button></th>
                    <th><button id="button-2-11" class="actionButton button-2" onclick="action(2, 11)">&nbsp;</button></th>
                    <th><button id="button-2-12" class="actionButton button-2" onclick="action(2, 12)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>3</th>
                    <th><button id="button-2-13" class="actionButton button-2" onclick="action(2, 13)">&nbsp;</button></th>
                    <th><button id="button-2-14" class="actionButton button-2" onclick="action(2, 14)">&nbsp;</button></th>
                    <th><button id="button-2-15" class="actionButton button-2" onclick="action(2, 15)">&nbsp;</button></th>
                    <th><button id="button-2-16" class="actionButton button-2" onclick="action(2, 16)">&nbsp;</button></th>
                    <th><button id="button-2-17" class="actionButton button-2" onclick="action(2, 17)">&nbsp;</button></th>
                    <th><button id="button-2-18" class="actionButton button-2" onclick="action(2, 18)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>4</th>
                    <th><button id="button-2-19" class="actionButton button-2" onclick="action(2, 19)">&nbsp;</button></th>
                    <th><button id="button-2-20" class="actionButton button-2" onclick="action(2, 20)">&nbsp;</button></th>
                    <th><button id="button-2-21" class="actionButton button-2" onclick="action(2, 21)">&nbsp;</button></th>
                    <th><button id="button-2-22" class="actionButton button-2" onclick="action(2, 22)">&nbsp;</button></th>
                    <th><button id="button-2-23" class="actionButton button-2" onclick="action(2, 23)">&nbsp;</button></th>
                    <th><button id="button-2-24" class="actionButton button-2" onclick="action(2, 24)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>5</th>
                    <th><button id="button-2-25" class="actionButton button-2" onclick="action(2, 25)">&nbsp;</button></th>
                    <th><button id="button-2-26" class="actionButton button-2" onclick="action(2, 26)">&nbsp;</button></th>
                    <th><button id="button-2-27" class="actionButton button-2" onclick="action(2, 27)">&nbsp;</button></th>
                    <th><button id="button-2-28" class="actionButton button-2" onclick="action(2, 28)">&nbsp;</button></th>
                    <th><button id="button-2-29" class="actionButton button-2" onclick="action(2, 29)">&nbsp;</button></th>
                    <th><button id="button-2-30" class="actionButton button-2" onclick="action(2, 30)">&nbsp;</button></th>
                </tr>
                <tr>
                    <th>6</th>
                    <th><button id="button-2-31" class="actionButton button-2" onclick="action(2, 31)">&nbsp;</button></th>
                    <th><button id="button-2-32" class="actionButton button-2" onclick="action(2, 32)">&nbsp;</button></th>
                    <th><button id="button-2-33" class="actionButton button-2" onclick="action(2, 33)">&nbsp;</button></th>
                    <th><button id="button-2-34" class="actionButton button-2" onclick="action(2, 34)">&nbsp;</button></th>
                    <th><button id="button-2-35" class="actionButton button-2" onclick="action(2, 35)">&nbsp;</button></th>
                    <th><button id="button-2-36" class="actionButton button-2" onclick="action(2, 36)">&nbsp;</button></th>
                </tr>
            </table>
            <br />
            <div id="status-1" style="margin: auto auto auto -32%;"><p><strong id="status-1-1">&nbsp;</strong></p><p><strong id="status-1-2">&nbsp;</strong></p><p><strong id="status-1-3">&nbsp;</strong></p></div>
            <div id="status-2" style="margin: -93px auto auto 32%;"><p><strong id="status-2-1">&nbsp;</strong></p><p><strong id="status-2-2">&nbsp;</strong></p><p><strong id="status-2-3">&nbsp;</strong></p></div>
            <p id="saveButtonLine" hidden><button id="saveButton" onclick="saveGame()" disabled>保存游戏</button></p>
            <div id="onlineFinish" hidden>
                <div id="onlineArea">
                    <h4>你的操作已经结束. 请将以下代码发送给你的好友:</h4>
                    <h5 id="onlineCode"></h5>
                    <p id="onlineInput">将好友发给你的代码输入: <input id="onlineCodeInput" style="width: 100px;" /><button id="onlineCodeBtn1" onclick="onlineCodeEnter()" disabled>确认</button><span id="onlineCodeConfirm" hidden>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button id="onlineCodeBtn2" onclick="onlineCodeEnter(true)">确认</button></span></p>
                    <h5 id="onlineWarn" class="STX"></h5>
                    </div>
                <p id="singleAwait" hidden></p>
            </div>
        </div>
        <h2 id="urlCodeErr" style="color: var(--red)" hidden></h2>
    </div>
    <script>
        copyright(2023);

        const shipwarURL = `${window.location.origin}/game/ship-war/?code=`;
        const currentVersion = 200;
        cw("#version").text = `${String(currentVersion).slice(0, 1)}.${String(currentVersion).slice(1)}`;

        const urlOnlineCode = urlParam.get("code");

        const settings = {
            first: 0,
            isFirstRandom: false,
            showSuggestion: true,
            showOffset: true,
            showOffsetSuggestion: true,
            hasSave: false
        };
        const stats = {
            phase: undefined,
            majors: 0,
            lastAtkWho: 0,
            win: false,
            
            p1: [null, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            p2: [null, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            hasMajor(p) {
                return stats[`p${p}`].includes(2);
            },
            shipCount(p) {
                return stats[`p${p}`].getCountOf(1) + stats[`p${p}`].getCountOf(2);
            },
            
            atkCombo: [],
            get atkHighest() {
                let highest = 0;
                stats.atkCombo.forEach(atk => { if (highest < atk[1]) { highest = atk[1]; } });
                return highest;
            },

            attackedPos: [[], []],
            lastAtkDist: [[0, 0], [0, 0]]
        };
        const online = {
            enabled: false,
            side: 0,
            memory: "",
            code: {
                generated: "",
                last: ""
            }
        };
        const robot = {
            enabled: false,
            majorPlaced: false,
            playerMajor: {
                promise: undefined,
                resolve: undefined
            },
            memory: {
                placeMinor: [],
                attack: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36]
            }
        };
        const cell = [null, "A1", "B1", "C1", "D1", "E1", "F1", "A2", "B2", "C2", "D2", "E2", "F2", "A3", "B3", "C3", "D3", "E3", "F3", "A4", "B4", "C4", "D4", "E4", "F4", "A5", "B5", "C5", "D5", "E5", "F5", "A6", "B6", "C6", "D6", "E6", "F6"];

        cw("#option-showSuggestion").event("change", function () {
            settings.showSuggestion = this.checked;
            if (settings.showSuggestion) {
                cw("#description-showSuggestion").color = "var(--textColor-500)";
                cw("#description-showSuggestion-1").color = "var(--minor)";
            } else {
                cw("#description-showSuggestion").color = "var(--gray)";
                cw("#description-showSuggestion-1").color = "var(--gray)";
            }
        });
        cw("#option-showOffset").event("change", function () {
            settings.showOffset = this.checked;
            if (settings.showOffset) {
                cw("#description-showOffset").color = "var(--textColor-500)";
                cw("#option-showOffsetSuggestion").disabled = false;
                cw("#option-showOffsetSuggestion").checked = true;
                settings.showOffsetSuggestion = true;
                cw("#description-showOffsetSuggestion").color = "var(--textColor-500)";
                if (settings.showOffsetSuggestion) {
                    cw("#description-showOffsetSuggestion-1").color = "var(--textColor-500)";
                    cw("#description-showOffsetSuggestion-2").color = "var(--lightOrange)";
                }
            } else {
                cw("#description-showOffset").color = "var(--gray)";
                cw("#option-showOffsetSuggestion").disabled = true;
                cw("#option-showOffsetSuggestion").checked = false;
                settings.showOffsetSuggestion = false;
                cw("#description-showOffsetSuggestion").color = "var(--gray)";
                cw("#description-showOffsetSuggestion-1").color = "var(--gray)";
                cw("#description-showOffsetSuggestion-2").color = "var(--gray)";
            }
        });
        cw("#option-showOffsetSuggestion").event("change", function () {
            settings.showOffsetSuggestion = this.checked;
            if (settings.showOffsetSuggestion && settings.showOffset) {
                cw("#description-showOffsetSuggestion-1").color = "var(--textColor-500)";
                cw("#description-showOffsetSuggestion-2").color = "var(--lightOrange)";
            } else {
                cw("#description-showOffsetSuggestion-1").color = "var(--gray)";
                cw("#description-showOffsetSuggestion-2").color = "var(--gray)";
            }
        });

        cw("#saveInput").event("change", () => { settings.hasSave = true; });
        cw("#joinMultiplayerCode").event("input", function () {
            if (this.value != "") { cw("#joinMultiplayerButton").disabled = false; }
        });
        cw("#onlineCodeInput").event("input", function () {
            if (this.value != "") { cw("#onlineCodeBtn1").disabled = false; }
            cw("#onlineCodeConfirm").hide();
            cw("#onlineWarn").hide();
        });

        function nextPage() {
            if (settings.hasSave) {
                loadGame();
            } else {
                fadeChange("rules", "chooseMode");
            }
        }

        // MAIN LOCAL GAME

        function singlePlayer(who) {
            settings.first = who || (settings.isFirstRandom = true, rand(1, 2));

            fadeChange("chooseMode", "mainPanel");
            cw("#statusTitle").text = "放置母舰";
            cw("#subtitle").text = "请准备好物理阻拦物, 确保玩家不会看到对方的操作界面";
            cw("#subtitle").color = "var(--red)";

            cw("#status-1-1").text = `${settings.first == 1 ? "我方" : "敌方"}先手 ${settings.isFirstRandom ? "(随机)" : "(指定)"}`;
            cw("#status-1-1").color = settings.first == 1 ? `var(--green)` : "var(--textColor-500)";
            cw("#status-1-2").text = `请选择母舰部署位置`;
            cw("#status-1-2").color = "var(--lightOrange)";
            cw("#status-2-1").text = `${settings.first == 2 ? "我方" : "敌方"}先手 ${settings.isFirstRandom ? "(随机)" : "(指定)"}`;
            cw("#status-2-1").color = settings.first == 2 ? `var(--green)` : "var(--textColor-500)";
            cw("#status-2-2").text = `请选择母舰部署位置`;
            cw("#status-2-2").color = "var(--lightOrange)";

            stats.phase = "placeMajor";
            cw("#saveButtonLine").unhide();
        }

        function action(who, pos) {
            if (stats.phase == "placeMajor") {
                placeMajor(who, pos);
                return;
            }
            if (stats.phase.includes("Minor")) {
                placeMinor(who, pos);
                return;
            }
            if (stats.phase.includes("Attack")) {
                attack(who, pos);
                return;
            }
        }

        function button(who, isAvailable, isMinor) {
            for (let i = 1; i <= 36; i++) {
                const toDisable = !isAvailable || isMinor && stats[`p${who}`][i] >= 1;

                cw(`#button-${who}-${i}`).disabled = toDisable;

                if (toDisable) {
                    cw(`#button-${who}-${i}`).style.border = "2px solid var(--textColor-400)";
                    cw(`#button-${who}-${i}`).html = "&nbsp;";
                } else {
                    cw(`#button-${who}-${i}`).style.border = "2px solid var(--activeColor-500)";
                }
            }
        }

        function updateDisplay() {
            stats.p1.forEach((value, index) => {
                if (index != 0) {
                    cw(`#display-1-${index}`).text = value == 1 ? "≡" : value == 2 ? "〓" : " ";
                }
            });
            stats.p2.forEach((value, index) => {
                if (index != 0) {
                    cw(`#display-2-${index}`).text = value == 1 ? "≡" : value == 2 ? "〓" : " ";
                }
            });
        }

        function showAttackPos(who, atkArr) {
            atkArr.forEach(atk => {
                cw(`#display-${who}-${atk[0]}`).html = `<span style="color: ${atk[1] == 2 ? "var(--darkRed)" : atk[1] == 1 ? "var(--minor)" : "var(--gray)"}">X</span>`;
                // Not using ChiwaSet.color to modify is to prevent color changes to cell when minors are placed later
            });
        }

        function updateStatus() {
            if (stats.phase.includes("Victory")) {
                button(1, false);
                button(2, false);
            } else {
                button(1, stats.phase.includes("p1"), stats.phase.includes("Minor"));
                button(2, stats.phase.includes("p2"), stats.phase.includes("Minor"));
            }

            if (stats.phase == "p1Minor") {
                cw("#status-1-1").text = "我方回合";
                cw("#status-1-1").color = "var(--green)";
                cw("#status-1-2").html = "请选择战略舰部署位置 <button onclick='skipMinor(1)'>跳过</button>";
                cw("#status-1-2").color = "var(--green)";
                cw("#status-2-1").text = "敌方回合";
                cw("#status-2-1").color = "var(--textColor-500)";
                cw("#status-2-2").text = "请等待敌方操作";
                cw("#status-2-2").color = "var(--textColor-500)";

                if (settings.showSuggestion) {
                    for (let i = 1; i <= 36; i++) { cw(`#button-1-${i}`).html = "&nbsp;"; }
                }
            }
            if (stats.phase == "p1Attack") {
                cw("#status-1-1").text = "我方回合";
                cw("#status-1-1").color = "var(--green)";
                cw("#status-1-2").text = "请选择攻击位置";
                cw("#status-1-2").color = "var(--red)";
                cw("#status-2-1").text = "敌方回合";
                cw("#status-2-1").color = "var(--textColor-500)";
                cw("#status-2-2").text = "请等待敌方操作";
                cw("#status-2-2").color = "var(--textColor-500)";

                if (settings.showSuggestion) {
                    for (let i = 1; i <= 36; i++) { cw(`#button-1-${i}`).html = "&nbsp;"; }
                    for (const pos of stats.attackedPos[0]) {
                        cw(`#button-1-${pos}`).html = "<span style='color: var(--minor)''>!</span>";
                    }
                }
                if (settings.showOffsetSuggestion) {
                    for (let i = 1; i <= 36; i++) { cw(`#button-1-${i}`).style.border = "2px solid var(--activeColor-500)"; }
                    const betterChoices = getPositionsAtDistance(...stats.lastAtkDist[0]);
                    betterChoices.forEach(pos => cw(`#button-1-${pos}`).style.border = "2px solid var(--lightOrange)");
                }
            }
            if (stats.phase == "p2Minor") {
                cw("#status-1-1").text = "敌方回合";
                cw("#status-1-1").color = "var(--textColor-500)";
                cw("#status-1-2").text = "请等待敌方操作";
                cw("#status-1-2").color = "var(--textColor-500)";
                cw("#status-2-1").text = "我方回合";
                cw("#status-2-1").color = "var(--green)";
                cw("#status-2-2").html = "请选择战略舰部署位置 <button onclick='skipMinor(2)'>跳过</button>";
                cw("#status-2-2").color = "var(--green)";

                if (settings.showSuggestion) {
                    for (let i = 1; i <= 36; i++) { cw(`#button-2-${i}`).html = "&nbsp;"; }
                }
            }
            if (stats.phase == "p2Attack") {
                cw("#status-1-1").text = "敌方回合";
                cw("#status-1-1").color = "var(--textColor-500)";
                cw("#status-1-2").text = "请等待敌方操作";
                cw("#status-1-2").color = "var(--textColor-500)";
                cw("#status-2-1").text = "我方回合";
                cw("#status-2-1").color = "var(--green)";
                cw("#status-2-2").text = "请选择攻击位置";
                cw("#status-2-2").color = "var(--red)";

                if (settings.showSuggestion) {
                    for (let i = 1; i <= 36; i++) { cw(`#button-2-${i}`).html = "&nbsp;"; }
                    for (const pos of stats.attackedPos[1]) {
                        cw(`#button-2-${pos}`).html = "<span style='color: var(--minor)''>!</span>";
                    }
                }
                if (settings.showOffsetSuggestion) {
                    for (let i = 1; i <= 36; i++) { cw(`#button-2-${i}`).style.border = "2px solid var(--activeColor-500)"; }
                    const betterChoices = getPositionsAtDistance(...stats.lastAtkDist[1]);
                    betterChoices.forEach(pos => cw(`#button-2-${pos}`).style.border = "2px solid var(--lightOrange)");
                }
            }
            if (stats.phase == "p1Victory") {
                cw("#statusTitle").text = "游戏结束";
                cw("#statusTitle").color = "var(--textColor-500)";
                cw("#saveButton").disabled = true;
                stats.win = true;
                cw("#singleAwait").hide();
                if (online.side == 1) {
                    onlineEncode();
                    cw("#onlineInput").hide();
                }

                if (!online.enabled) {
                    cw("#subtitle").text = "<------ P1 胜利!";
                    cw("#subtitle").color = "var(--green)";
                }
                if (online.enabled) {
                    if (online.side == 1) {
                        cw("#subtitle").text = "我方胜利!";
                        cw("#subtitle").color = "var(--lightOrange)";
                    } else {
                        cw("#subtitle").text = "我方战败";
                        cw("#subtitle").color = "var(--red)";
                    }
                }

                cw("#status-1-1").text = "我方胜利!";
                cw("#status-1-1").color = "var(--lightOrange)";
                cw("#status-1-2").text = "我方已击沉敌方所有军舰!";
                cw("#status-1-2").color = "var(--lightOrange)";
                cw("#status-2-1").text = "我方战败";
                cw("#status-2-1").color = "var(--red)";
                cw("#status-2-2").html = "我方所有军舰已被击沉";
                cw("#status-2-2").color = "var(--red)";
            }
            if (stats.phase == "p2Victory") {
                cw("#statusTitle").text = "游戏结束";
                cw("#statusTitle").color = "var(--textColor-500)";
                cw("#saveButton").disabled = true;
                stats.win = true;
                cw("#singleAwait").hide();
                if (online.side == 2) {
                    onlineEncode();
                    cw("#onlineInput").hide();
                }

                if (!online.enabled) {
                    cw("#subtitle").text = "P2 胜利! ------>";
                    cw("#subtitle").color = "var(--green)";
                }
                if (online.enabled) {
                    if (online.side == 2) {
                        cw("#subtitle").text = "我方胜利!";
                        cw("#subtitle").color = "var(--lightOrange)";
                    } else {
                        cw("#subtitle").text = "我方战败";
                        cw("#subtitle").color = "var(--red)";
                    }
                }

                cw("#status-1-1").text = "我方战败";
                cw("#status-1-1").color = "var(--red)";
                cw("#status-1-2").html = "我方所有军舰已被击沉";
                cw("#status-1-2").color = "var(--red)";
                cw("#status-2-1").text = "我方胜利!";
                cw("#status-2-1").color = "var(--lightOrange)";
                cw("#status-2-2").text = "我方已击沉敌方所有军舰!";
                cw("#status-2-2").color = "var(--lightOrange)";
            }

            if (online.enabled && stats.phase.includes("p1") == (online.side == 2)) {
                onlineEncode();
            }
        }

        function placeMajor(who, pos) {
            stats[`p${who}`][pos] = 2;
            updateDisplay();
            cw(`#status-${who}-3`).text = `母舰已部署 (${cell[pos]})`;
            cw(`#status-${who}-3`).color = "var(--gray)";

            if (online.enabled) {
                // Add settings to memory
                let settingsMemory = 0;
                if (settings.showSuggestion) { settingsMemory |= 0b001; }
                if (settings.showOffset) { settingsMemory |= 0b010; }
                if (settings.showOffsetSuggestion) { settingsMemory |= 0b100; }
                online.memory += `${stats.majors == 0 ? settings.first + Number(settings.isFirstRandom) * 2 : "3"}${online.side == 1 ? settingsMemory : ""}${String(pos).padStart(2, "0")}`;
            }
            
            stats.majors++;

            if (stats.majors == 1) {
                cw(`#status-${who}-2`).text = `请等待敌方选择母舰部署位置`;
                cw(`#status-${who}-2`).color = "var(--textColor-500)";
                button(who, false);

                if (online.enabled) {
                    onlineEncode();
                }
                if (robot.majorPlaced) {
                    robot.playerMajor.resolve();
                }
            }
            if (stats.majors == 2) {
                cw("#statusTitle").text = "游戏进行中";
                cw("#statusTitle").color = "var(--green)";
                cw("#saveButton").disabled = false;
                stats.phase = `p${settings.first}Minor`;
                updateStatus();
            }
        }

        function placeMinor(who, pos) {
            stats[`p${who}`][pos] = 1;
            updateDisplay();
            cw(`#status-${who}-3`).text = `战列舰已部署 (${cell[pos]})`;
            cw(`#status-${who}-3`).color = "var(--gray)";

            if (online.enabled) { online.memory += `1${String(pos).padStart(2, "0")}`; }

            stats.phase = `p${who}Attack`;
            updateStatus();
        }

        function skipMinor(who, pos) {
            cw(`#status-${who}-3`).text = `战列舰部署已跳过`;
            cw(`#status-${who}-3`).color = "var(--gray)";

            stats.phase = `p${who}Attack`;
            updateStatus();
        }

        function attack(who, pos) { // "who" is the one who intends to attack
            if (stats.lastAtkWho != who) {
                stats.atkCombo = [];
            }
            stats.lastAtkWho = who;
            stats.attackedPos[who - 1].push(pos);

            const attackTarget = who == 1 ? 2 : 1;
            let target = false;

            if (stats[`p${attackTarget}`][pos] == 0) {
                stats.atkCombo.push([pos, 0]);
                cw(`#status-${who}-3`).html = settings.showOffset ? `打空 (${atkComboToStr()}) - 距离敌军舰 ${minManhattanDistance(pos, stats[`p${attackTarget}`])} 格` : `未发现敌方军舰 (${atkComboToStr()})`;
                cw(`#status-${who}-3`).color = "var(--gray)";
                cw(`#status-${attackTarget}-3`).html = `敌方打空 (${atkComboToStr()})`;
                cw(`#status-${attackTarget}-3`).color = "var(--gray)";
                stats.lastAtkDist[who - 1] = [pos, minManhattanDistance(pos, stats[`p${attackTarget}`])];
            }
            if (stats[`p${attackTarget}`][pos] == 1) {
                stats.atkCombo.push([pos, 1]);
                target = true;
                cw(`#status-${who}-3`).html = `已击沉敌方一艘战略舰! (${atkComboToStr()})`;
                cw(`#status-${who}-3`).color = "var(--minor)";
                cw(`#status-${attackTarget}-3`).html = `我方一艘战略舰已被击沉! (${atkComboToStr()})`;
                cw(`#status-${attackTarget}-3`).color = "var(--minor)";
                stats.lastAtkDist[who - 1] = [];
            }
            if (stats[`p${attackTarget}`][pos] == 2) {
                stats.atkCombo.push([pos, 2]);
                target = true;
                cw(`#status-${who}-3`).html = `已击沉敌方母舰! (${atkComboToStr()})`;
                cw(`#status-${who}-3`).color = "var(--darkRed)";
                cw(`#status-${attackTarget}-3`).html = `我方母舰已被击沉! (${atkComboToStr()})`;
                cw(`#status-${attackTarget}-3`).color = "var(--darkRed)";
                stats.attackedPos[who - 1] = [pos];
                stats.lastAtkDist[who - 1] = [];
            }

            if (online.enabled && stats.atkHighest == 1) {
                cw(`#status-${attackTarget}-3`).html = `我方一艘战略舰已被击沉! (${atkComboToStr()})`;
                cw(`#status-${attackTarget}-3`).color = "var(--minor)";
            }
            if (online.enabled && stats.atkHighest == 2) {
                cw(`#status-${attackTarget}-3`).html = `我方母舰已被击沉! (${atkComboToStr()})`;
                cw(`#status-${attackTarget}-3`).color = "var(--darkRed)";
            }

            stats[`p${attackTarget}`][pos] = 0;
            updateDisplay();
            showAttackPos(attackTarget, stats.atkCombo);

            if (online.enabled) { online.memory += `2${String(pos).padStart(2, "0")}`; }

            if (stats.shipCount(attackTarget) == 0) {
                stats.phase = `p${who}Victory`;
            } else if (!stats.hasMajor(who) && target) {
                stats.phase = `p${who}Attack`;
            } else if (stats.hasMajor(attackTarget)) {
                stats.phase = `p${attackTarget}Minor`;
                if (robot.enabled && who == 1) { robotAction(1); }
            } else {
                stats.phase = `p${attackTarget}Attack`;
                if (robot.enabled && who == 1) { robotAction(1); }
            }

            updateStatus();
        }

        function atkComboToStr() {
            let str = "";

            stats.atkCombo.forEach(arr => {
                if (arr[1] == 0) { str += `, <span style='color: var(--gray);'>${cell[arr[0]]}</span>`; }
                if (arr[1] == 1) { str += `, <span style='color: var(--minor);'>${cell[arr[0]]}</span>`; }
                if (arr[1] == 2) { str += `, <span style='color: var(--darkRed);'>${cell[arr[0]]}</span>`; }
            });

            return str.slice(2);
        }

        function minManhattanDistance(pos, mark) {
            // 1. 将pos转换为坐标
            const posRow = Math.floor((pos - 1) / 6);
            const posCol = (pos - 1) % 6;

            // 2. 收集所有被标记的格子坐标
            const markedPositions = [];
            for (let i = 1; i <= 36; i++) {
                if (mark[i] >= 1) {
                    const row = Math.floor((i - 1) / 6);
                    const col = (i - 1) % 6;
                    markedPositions.push({ row, col });
                }
            }
        
            // 如果没有被标记的格子，返回Infinity
            if (markedPositions.length === 0) {
                return Infinity;
            }
        
            // 3. 计算所有曼哈顿距离并找最小值
            let minDistance = Infinity;
            for (const { row, col } of markedPositions) {
                const distance = Math.abs(posRow - row) + Math.abs(posCol - col);
                if (distance < minDistance) {
                    minDistance = distance;
                }
            }
        
            return minDistance;
        }

        function getPositionsAtDistance(pos, dist) {
            const result = [];
            const posRow = Math.floor((pos - 1) / 6);
            const posCol = (pos - 1) % 6;

            for (let i = 1; i <= 36; i++) {
                const iRow = Math.floor((i - 1) / 6);
                const iCol = (i - 1) % 6;
                const distance = Math.abs(posRow - iRow) + Math.abs(posCol - iCol);
                if (distance === dist) {
                    result.push(i);
                }
            }
        
            return result;
        }

        // SAVE & LOAD

        function saveGame() {
            const p1Status = [];
            if (cw("#status-1-3").text.includes("母舰已部署")) { p1Status.push("deployedMajor"); }
            if (cw("#status-1-3").text.includes("战列舰已部署")) { p1Status.push("deployedMinor"); }
            if (cw("#status-1-3").text.includes("战列舰部署已跳过")) { p1Status.push("skipped"); }
            if (cw("#status-1-3").text.includes("未发现敌方军舰") || cw("#status-1-3").text.includes("距离敌军舰")) { p1Status.push("undetected"); }
            if (cw("#status-1-3").text.includes("敌方打空")) { p1Status.push("missed"); }
            if (cw("#status-1-3").text.includes("已击沉敌方一艘战列舰!")) { p1Status.push("minorDestroyed"); }
            if (cw("#status-1-3").text.includes("已击沉敌方母舰!")) { p1Status.push("majorDestroyed"); }
            if (cw("#status-1-3").text.includes("我方一艘战列舰已被击沉!")) { p1Status.push("minorSank"); }
            if (cw("#status-1-3").text.includes("我方母舰已被击沉!")) { p1Status.push("majorSank"); }

            if (p1Status[0].includes("deployed")) {
                p1Status.push(cw("#status-1-3").text.match(/\(([A-F][1-6])\)/)[1]);
            }

            const p2Status = [];
            if (cw("#status-2-3").text.includes("母舰已部署")) { p2Status.push("deployedMajor"); }
            if (cw("#status-2-3").text.includes("战列舰已部署")) { p2Status.push("deployedMinor"); }
            if (cw("#status-2-3").text.includes("战列舰部署已跳过")) { p1Status.push("skipped"); }
            if (cw("#status-2-3").text.includes("未发现敌方军舰") || cw("#status-2-3").text.includes("距离敌军舰")) { p2Status.push("undetected"); }
            if (cw("#status-2-3").text.includes("敌方打空")) { p2Status.push("missed"); }
            if (cw("#status-2-3").text.includes("已击沉敌方一艘战列舰!")) { p2Status.push("minorDestroyed"); }
            if (cw("#status-2-3").text.includes("已击沉敌方母舰!")) { p2Status.push("majorDestroyed"); }
            if (cw("#status-2-3").text.includes("我方一艘战列舰已被击沉!")) { p2Status.push("minorSank"); }
            if (cw("#status-2-3").text.includes("我方母舰已被击沉!")) { p2Status.push("majorSank"); }

            if (p2Status[0].includes("deployed")) {
                p2Status.push(cw("#status-2-3").text.match(/\(([A-F][1-6])\)/)[1]);
            }

            const data = {
                signature: "chiwainori-shipWar",
                version: currentVersion,
                time: new Date().getTime(),
                data: {
                    settings: {
                        first: settings.first,
                        isFirstRandom: settings.isFirstRandom,
                        showSuggestion: settings.showSuggestion,
                        showOffset: settings.showOffset,
                        showOffsetSuggestion: settings.showOffsetSuggestion
                    },
                    stats: {
                        phase: stats.phase,
                        lastAtkWho: stats.lastAtkWho,
                        atkCombo: stats.atkCombo,
                        p1: stats.p1,
                        p2: stats.p2,
                        attackedPos: stats.attackedPos,
                        lastAtkDist: stats.lastAtkDist
                    },
                    status: {
                        p1: p1Status,
                        p2: p2Status
                    }
                }
            };

            save(`chiwainori-shipWar-${data.time}.json`, JSON.stringify(data));
        }

        async function loadGame() {
            let file;

            try {
                file = await loadJSON("saveInput");
            } catch (e) {
                if (e.cwErr == "f-loadJSON-invalid") {
                    cw("#saveText").text = `无效的 JSON 文件`;
                    cw("#saveText").color = "var(--red)";
                    return;
                }
                cw("#saveText").html = e.stack;
                cw("#saveText").color = "var(--red)";
                return;
            }

            await sleep(50);

            if (file.signature != "chiwainori-shipWar") {
                cw("#saveText").text = `错误的文件签名 (${file.signature})`;
                cw("#saveText").color = "var(--red)";
                return;
            }
            if (file.version != currentVersion) {
                cw("#saveText").text = `错误的文件版本 (${file.version}, 当前 ${currentVersion}). 请在本网页的地址后面加上 /../archive_${file.version}.html 以尝试在其他版本中加载.`;
                cw("#saveText").color = "var(--red)";
                return;
            }

            fadeChange("rules", "mainPanel");

            settings.first = file.data.settings.first;
            settings.isFirstRandom = file.data.settings.isFirstRandom;
            settings.showSuggestion = file.data.settings.showSuggestion;
            settings.showOffset = file.data.settings.showOffset;
            settings.showOffsetSuggestion = file.data.settings.showOffsetSuggestion;
            stats.phase = file.data.stats.phase;
            stats.lastAtkWho = file.data.stats.lastAtkWho;
            stats.p1 = file.data.stats.p1;
            stats.p2 = file.data.stats.p2;
            stats.atkCombo = file.data.stats.atkCombo;
            stats.attackedPos = file.data.stats.attackedPos;
            stats.lastAtkDist = file.data.stats.lastAtkDist;

            updateDisplay();
            updateStatus();

            if (file.data.status.p1[0] == "deployedMajor") {
                cw("#status-1-3").text = `母舰已部署 (${file.data.status.p1[1]})`;
                cw("#status-1-3").color = "var(--gray)";
            }
            if (file.data.status.p1[0] == "deployedMinor") {
                cw("#status-1-3").text = `战列舰已部署 (${file.data.status.p1[1]})`;
                cw("#status-1-3").color = "var(--gray)";
            }
            if (file.data.status.p1[0] == "skipped") {
                cw("#status-1-3").text = "战列舰部署已跳过";
                cw("#status-1-3").color = "var(--gray)";
            }
            if (file.data.status.p1[0] == "undetected") {
                cw("#status-1-3").html = settings.showOffset ? `打空 (${atkComboToStr()}) - 距离敌军舰 ${stats.lastAtkDist[0][1]} 格` : `未发现敌方军舰 (${atkComboToStr()})`;
                cw("#status-1-3").color = "var(--gray)";
            }
            if (file.data.status.p1[0] == "missed") {
                cw("#status-1-3").html = `敌方打空 (${atkComboToStr()})`;
                cw("#status-1-3").color = "var(--gray)";
            }
            if (file.data.status.p1[0] == "minorDestroyed") {
                cw("#status-1-3").html = `已击沉敌方一艘战列舰! (${atkComboToStr()})`;
                cw("#status-1-3").color = "var(--minor)";
            }
            if (file.data.status.p1[0] == "majorDestroyed") {
                cw("#status-1-3").html = `已击沉敌方母舰! (${atkComboToStr()})`;
                cw("#status-1-3").color = "var(--darkRed)";
            }
            if (file.data.status.p1[0] == "minorSank") {
                cw("#status-1-3").html = `我方一艘战列舰已被击沉! (${atkComboToStr()})`;
                cw("#status-1-3").color = "var(--minor)";
            }
            if (file.data.status.p1[0] == "majorSank") {
                cw("#status-1-3").html = `我方母舰已被击沉! (${atkComboToStr()})`;
                cw("#status-1-3").color = "var(--darkRed)";
            }

            if (file.data.status.p2[0] == "deployedMajor") {
                cw("#status-2-3").text = `母舰已部署 (${file.data.status.p2[1]})`;
                cw("#status-2-3").color = "var(--gray)";
            }
            if (file.data.status.p2[0] == "deployedMinor") {
                cw("#status-2-3").text = `战列舰已部署 (${file.data.status.p2[1]})`;
                cw("#status-2-3").color = "var(--gray)";
            }
            if (file.data.status.p2[0] == "skipped") {
                cw("#status-2-3").text = "战列舰部署已跳过";
                cw("#status-2-3").color = "var(--gray)";
            }
            if (file.data.status.p2[0] == "undetected") {
                cw("#status-2-3").html = settings.showOffset ? `打空 (${atkComboToStr()}) - 距离敌军舰 ${stats.lastAtkDist[1][1]} 格` : `未发现敌方军舰 (${atkComboToStr()})`;
                cw("#status-2-3").color = "var(--gray)";
            }
            if (file.data.status.p2[0] == "missed") {
                cw("#status-2-3").html = `敌方打空 (${atkComboToStr()})`;
                cw("#status-2-3").color = "var(--gray)";
            }
            if (file.data.status.p2[0] == "minorDestroyed") {
                cw("#status-2-3").html = `已击沉敌方一艘战列舰! (${atkComboToStr()})`;
                cw("#status-2-3").color = "var(--minor)";
            }
            if (file.data.status.p2[0] == "majorDestroyed") {
                cw("#status-2-3").html = `已击沉敌方母舰! (${atkComboToStr()})`;
                cw("#status-2-3").color = "var(--darkRed)";
            }
            if (file.data.status.p2[0] == "minorSank") {
                cw("#status-2-3").html = `我方一艘战列舰已被击沉! (${atkComboToStr()})`;
                cw("#status-2-3").color = "var(--minor)";
            }
            if (file.data.status.p2[0] == "majorSank") {
                cw("#status-2-3").html = `我方母舰已被击沉! (${atkComboToStr()})`;
                cw("#status-2-3").color = "var(--darkRed)";
            }

            cw("#statusTitle").html = "游戏进行中";
            cw("#statusTitle").color = "var(--green)";
            cw("#subtitle").text = "请准备好物理阻拦物, 确保玩家不会看到对方的操作界面";
            cw("#subtitle").color = "var(--red)";
            cw("#saveButtonLine").unhide();
            cw("#saveButton").disabled = false;
        }

        // MULTIPLAYER

        function multiplayer(who) {
            settings.first = who || (settings.isFirstRandom = true, rand(1, 2));
            online.enabled = true;
            online.side = 1;

            fadeChange("chooseMode", "mainPanel");
            cw("#statusTitle").text = "放置母舰";
            cw("#subtitle").text = "联机模式";

            cw("#status-1-1").text = `${settings.first == 1 ? "我方" : "敌方"}先手 ${settings.isFirstRandom ? "(随机)" : "(指定)"}`;
            cw("#status-1-1").color = settings.first == 1 ? `var(--green)` : "var(--textColor-500)";
            cw("#status-1-2").text = `请选择母舰部署位置`;
            cw("#status-1-2").color = "var(--lightOrange)";
            
            cw("#status-1").style = "margin: auto auto auto auto !important;";
            cw("#table-1-d").style = "margin: auto auto auto auto !important;";
            cw("#table-1-o").style = "margin: auto auto auto auto !important;";
            cw("#status-2").hide();
            cw("#table-2-d").hide();
            cw("#table-2-o").hide();

            stats.phase = "placeMajor";
        }

        function onlineEncode() {
            cw("#onlineFinish").unhide();

            const key = BigInt(rand(1, 1295)); // 36 base 01 ~ ZZ
            code = (BigInt(online.memory) ^ key << 2n) + key;

            if ((/^[1-4][0-7]([0-2][0-9]|3[0-6])$/).test(online.memory) && online.side == 1) {
                cw("#onlineCode").html = `<span style="color: var(--gray)">${shipwarURL}</span><span style="font-size: 24px; letter-spacing: 12px; font-family: Consolas;">${key.toBase(36).padStart(2, "0")}${code.toBase(36)}</span>`;
            } else {
                cw("#onlineCode").text = `${key.toBase(36).padStart(2, "0")}${code.toBase(36)}`;
                cw("#onlineCode").style = "font-size: 24px; letter-spacing: 12px; font-family: Consolas;";
            }
            cw("#onlineCodeInput").value = "";
            online.memory = "";
            online.code.generated = `${key.toBase(36).padStart(2, "0")}${code.toBase(36)}`;
        }

        function onlineDecode(code) {
            const key = BigInt(code.slice(0, 2).transBase(36, 10));
            const content = BigInt(code.slice(2).transBase(36, 10));

            return String(content - key ^ key << 2n);
        }

        if (urlOnlineCode) { joinMultiplayer(1); }

        function joinMultiplayer(where) {
            let code;
            
            if (where == 1) {
                code = onlineDecode(urlOnlineCode);
                if (checkCode(code, "join")) {
                    cw("#urlCodeErr").text = `错误的联机代码 ${checkCode(code, "join")}`;
                    cw("#urlCodeErr").unhide();
                    cw("#rules").hide();
                    return;
                }
            }
            if (where == 2) {
                code = onlineDecode(cw("#joinMultiplayerCode").value);
                if (checkCode(code, "join")) {
                    cw("#wrongCode").text = `错误的联机代码 ${checkCode(code, "join")}`;
                    cw("#wrongCode").unhide();
                    cw("#rules").hide();
                    return;
                }
            }

            const settingsMemory = code[1];
            settings.showSuggestion = Boolean(settingsMemory & 0b001);
            settings.showOffset = Boolean(settingsMemory & 0b010);
            settings.showOffsetSuggestion = Boolean(settingsMemory & 0b100);

            const first = code[0];
            settings.first = first > 2 ? first - 2 : first;
            settings.isFirstRandom = first >= 3;

            const majorPos = Number(code.slice(2));
            stats.p1[majorPos] = 2;
            stats.majors = 1;
            updateDisplay();

            online.enabled = true;
            online.side = 2;

            if (where == 1) {
                cw("#rules").hide();
                cw("#mainPanel").unhide();
            }
            if (where == 2) {
                fadeChange("#chooseMode", "#mainPanel");
            }
            cw("#statusTitle").text = "放置母舰";
            cw("#subtitle").text = "联机模式";

            cw("#status-2-1").text = `${settings.first == 2 ? "我方" : "敌方"}先手 ${settings.isFirstRandom ? "(随机)" : "(指定)"}`;
            cw("#status-2-1").color = settings.first == 2 ? `var(--green)` : "var(--textColor-500)";
            cw("#status-2-2").text = `请选择母舰部署位置`;
            cw("#status-2-2").color = "var(--lightOrange)";
            
            cw("#status-2").style = "margin: auto auto auto auto !important;";
            cw("#table-2-d").style = "margin: auto auto auto auto !important;";
            cw("#table-2-o").style = "margin: auto auto auto auto !important;";
            cw("#status-1").hide();
            cw("#table-1-d").hide();
            cw("#table-1-o").hide();

            stats.phase = "placeMajor";
        }

        function checkCode(code, method) {
            if (method == "join") {
                if (!(/^[1-4][0-7]([0-2][0-9]|3[0-6])$/).test(code)) {
                    if (!(/^.{4}$/).test(code)) { return `of invalid-length for ${code.length}`; }
                    if ((/-/).test(code)) { return `of neg at ${code.slice(0, 2)}`; }
                    if ((/^[05-9]/).test(code)) { return `of invalid-first for ${code[0]}`; }
                    if (!(/^.[89]/).test(code)) { return `of invalid-settings for ${code[1]}`; }
                    if ((/(3[7-9]|[4-9].)$/).test(code)) { return `of invalid-pos for ${code.slice(2)}`; }

                    return `of unknown for ${code}`;
                }

                return false;
            }
            if (method == "receive") {
                if (!(/^[1-3]([0-2][0-9]|3[0-6])$/).test(code)) {
                    if (!(/^.{3}$/).test(code)) { return `of invalid-length for ${code.length}`; }
                    if ((/-/).test(code)) { return `of neg at ${code.slice(0, 2)}`; }
                    if ((/^[04-9]/).test(code)) { return `of invalid-act for ${code[0]}`; }
                    if ((/(3[7-9]|[4-9].)$/).test(code)) { return `of invalid-pos for ${code.slice(1)}`; }

                    return `of unknown for ${code}`;
                }

                return false;
            }
        }

        function onlineCodeEnter(force = false, robotCode = "") {
            const codeBeforeDecode = cw("#onlineCodeInput").value;
            const code = robotCode || onlineDecode(codeBeforeDecode);
            const codeArr = [];

            for (let i = 0; i < code.length; i += 3) {
                codeArr.push(code.slice(i, i + 3));
            }

            for (let i = 0; i < codeArr.length; i++) {
                if (checkCode(codeArr[i], "receive")) {
                    cw("#onlineWarn").text = `错误的联机代码 ${checkCode(codeArr[i], "receive")} at ${i}`;
                    cw("#onlineWarn").color = "var(--red)";
                    cw("#onlineWarn").unhide();
                    return;
                }
            }

            cw("#onlineCodeBtn1").disabled = true;
            if (!force && codeBeforeDecode == online.code.generated) {
                cw("#onlineWarn").text = "你输入的代码与你刚生成的代码相同。如确认无误，请按下新的确认按钮。";
                cw("#onlineWarn").color = "var(--orange)";
                cw("#onlineWarn").unhide();
                cw("#onlineCodeConfirm").unhide("inline-block");
                return;
            }
            if (!force && codeBeforeDecode == online.code.last) {
                cw("#onlineWarn").text = "你输入的代码与你上次输入的相同。如确认无误，请按下新的确认按钮。";
                cw("#onlineWarn").color = "var(--orange)";
                cw("#onlineWarn").unhide();
                cw("#onlineCodeConfirm").unhide("inline-block");
                return;
            }
            cw("#onlineWarn").hide();
            cw("#onlineCodeConfirm").hide();

            const applyTarget = online.side == 1 ? 2 : 1;
            for (let i = 0; i < codeArr.length; i++) {
                const act = codeArr[i];
                const pos = Number(act.slice(1));

                if (act[0] == "1") {
                    stats[`p${applyTarget}`][pos] = 1;
                }
                if (act[0] == "2") {
                    attack(applyTarget, pos);
                }
                if (act[0] == "3") {
                    stats[`p${applyTarget}`][pos] = 2;
                }
            }

            if (stats.phase == "placeMajor") {
                stats.phase = "p1Minor";
                updateStatus();
            }

            online.code.last = String(codeBeforeDecode);
            online.memory = "";
            cw("#onlineFinish").hide();
        }

        // ROBOT VERSUS

        function startRobot(first) {
            robot.enabled = true;
            multiplayer(first);
            cw("#onlineArea").hide();
            cw("#singleAwait").unhide();
            cw("#subtitle").text = "单人游戏";

            robotAction(0);
        }

        async function robotAction(type) {
            if (stats.win) {
                cw("#singleAwait").hide();
                return;
            }
            
            if (type == 0) { // PlaceBig
                cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 .";
                await sleep(rand(150, 300));
                cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 ..";
                await sleep(rand(150, 300));
                cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 ...";
                await sleep(rand(150, 300));
                cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 ....";
                await sleep(rand(150, 300));
                cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 .....";
                await sleep(rand(150, 300));
                
                const code = `3${String(rand(1, 36)).padStart(2, "0")}`;
                robot.majorPlaced = true;

                if (!stats.hasMajor(1)) {
                    robot.playerMajor.promise = new Promise(resolve => robot.playerMajor.resolve = resolve);
                    await robot.playerMajor.promise;
                }

                onlineCodeEnter(true, code);

                cw("#statusTitle").html = "游戏进行中";
                cw("#statusTitle").color = "var(--green)";
                stats.phase = `p${settings.first}Minor`;
                updateStatus();

                if (settings.first == 2) {
                    cw("#onlineFinish").unhide();
                    robotAction(1);
                }
                
                return;
            }
            
            let code = "";

            if (stats.hasMajor(2) && chance(botWillToPlaceMinor(stats.shipCount(2)))) {
                robot.memory.placeMinor = [];
                for (let i = 1; i <= 36; i++) {
                    if (stats.p2[i] == 0) { robot.memory.placeMinor.push(i); }
                }

                const placeSmallPos = robot.memory.placeMinor[rand(0, robot.memory.placeMinor.length - 1)];
                robot.memory.placeMinor = robot.memory.placeMinor.remove(placeSmallPos);
                code += `1${String(placeSmallPos).padStart(2, "0")}`;
            }

            let missed = false;
            let timer = 0;

            while (!missed) {
                const attackPos = robot.memory.attack[rand(0, robot.memory.attack.length - 1)];
                robot.memory.attack = robot.memory.attack.remove(attackPos);
                code += `2${String(attackPos).padStart(2, "0")}`;

                if (stats.p1[attackPos] == 2) { // Big sank, reset attack table
                    robot.memory.attack = [];
                    for (let i = 1; i <= 36; i++) { robot.memory.attack.push(i); }
                    robot.memory.attack = robot.memory.attack.remove(attackPos);
                }

                if (stats.p1[attackPos] != 1 && stats.p1[attackPos] != 2 || stats.hasMajor(2) || stats.p1[attackPos] >= 1 && stats.shipCount(1) == 1) {
                    missed = true; // Miss when: 1. P2 missed; 2. P2 has major; 3. P1 has 1 ship and attacked a ship (game finishes)
                }

                timer += rand(1500, 2500);
            }

            timer /= 5;
            cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 .";
            await sleep(rand(timer - 100, timer + 100));
            cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 ..";
            await sleep(rand(timer - 100, timer + 100));
            cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 ...";
            await sleep(rand(timer - 100, timer + 100));
            cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 ....";
            await sleep(rand(timer - 100, timer + 100));
            cw("#singleAwait").text = "你的操作已经结束。请等待对手操作 .....";
            await sleep(rand(timer - 100, timer + 100));

            onlineCodeEnter(true, code);
        }

        function botWillToPlaceMinor(shipOnBoard) {
            return shipOnBoard.percentage(rand(4, 6), rand(7, 9)).transit(1, 0); // Best strategy is to keep 7 ships in total from AI
        }
    </script>
</div></body>

</html>