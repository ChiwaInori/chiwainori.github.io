<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>2310 班随机选人 - ChiwaInori.top</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/type-center.css" />
    <style></style>
    <script src="/inori-functions.js"></script>
</head>

<body><div class="mainBody">
    <div class="title">
        <h1>2310 班随机选人</h1>
    </div>
    <div class="content">
        <div id="validationInvalid" hide>
            <h1 style="color: var(--red); font-size: 64px;"><strong>读取的动态随机抽取进度无法通过验证</strong></h1>
            <h1 style="color: var(--red); font-size: 48px;">这表示已保存的抽取进度可能遭到篡改。</h1>
            <h1 style="color: var(--red); font-size: 48px;">为保证抽取公平性，读取进度已终止。</h1>
            <h1 style="font-size: 48px;"><a href="https://chiwainori.top/rp/2310/">点击跳转至在线抽取网站</a></h1>
        </div>
        <div id="rollPanel">
            <p id="readSuccess" style="color: var(--green);" hide>已成功读取 <strong id="saveTime"></strong> 动态随机抽取进度</p>
            <p id="nextBirthday"></p>
            <h1 id="name" style="font-size: 120px; margin-top: 250px; margin-bottom: 140px;">点击下方按钮进行随机选人</h1>
            <p id="dynamic-chance-doyouknow" style="font-size: 24px;">&nbsp;</p>
            <p id="s-true" style="margin-left: -26px; display: none;"><strong><ruby>真随机<rt>固定概率</rt></ruby> | <a class="LNK"onclick="changeMode('dynamic')"><ruby>动态随机<rt>动态加权概率</rt></ruby></a> | <a class="LNK"onclick="changeMode('false')"><ruby>伪随机<rt>无重复抽取</rt></ruby></a></strong></p>
            <p id="s-dynamic" style="margin-left: -26px;"><strong><a class="LNK" onclick="changeMode('true')"><ruby>真随机<rt>固定概率</rt></ruby></a> | <ruby>动态随机<rt>动态加权概率</rt></ruby> | <a class="LNK" onclick="changeMode('false')"><ruby>伪随机<rt>无重复抽取</rt></ruby></a></strong></p>
            <p id="s-false" style="margin-left: -26px; display: none;"><strong><a class="LNK" onclick="changeMode('true')"><ruby>真随机<rt>固定概率</rt></ruby></a> | <a class="LNK" onclick="changeMode('dynamic')"><ruby>动态随机<rt>动态加权概率</rt></ruby></a> | <ruby>伪随机<rt>无重复抽取</rt></ruby></strong></p>
            <p id="buttonLine"><button onclick="roll('all')">随机选人</button><button style="margin-left: 420px;" onclick="roll('all')">随机选人</button><button style="margin-left: 450px;" onclick="roll('all')">随机选人</button></p>
            <br />
            <p>
                <span id="findBySex">
                    <button style="color: var(--blue); border-color: 2px solid var(--blue);" onclick="roll('boy')">选男生</button>
                    <button style="color: var(--pink); border-color: 2px solid var(--aqua);" onclick="roll('girl')">选女生</button>
                </span>
                <span id="findByIdLine"><strong id="findById" style="color: #666666;" onclick="findByIdReset()">按学号找人</strong> 
                    <button id="b-0" class="idButton" onclick="num(0)" disabled="disabled">0</button>
                    <button id="b-1" class="idButton" onclick="num(1)" disabled="disabled">1</button>
                    <button id="b-2" class="idButton" onclick="num(2)" disabled="disabled">2</button>
                    <button id="b-3" class="idButton" onclick="num(3)" disabled="disabled">3</button>
                    <button id="b-4" class="idButton" onclick="num(4)" disabled="disabled">4</button>
                    <button id="b-5" class="idButton" onclick="num(5)" disabled="disabled">5</button>
                    <button id="b-6" class="idButton" onclick="num(6)" disabled="disabled">6</button>
                    <button id="b-7" class="idButton" onclick="num(7)" disabled="disabled">7</button>
                    <button id="b-8" class="idButton" onclick="num(8)" disabled="disabled">8</button>
                    <button id="b-9" class="idButton" onclick="num(9)" disabled="disabled">9</button>
                </span></p>
            <p><input id="skipAnimation" type="checkbox" style="margin-left: 0px;" /> <strong>跳过动画</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input id="rollTeachers" type="checkbox" style="margin-left: 0px;" /> <strong>抽取科任老师</strong></p>
            <audio id="click" src="../click.mp3" style="display: none;" preload="auto"></audio>
            <p id="showChanceLine" class="LNK" onclick="revealChance()">点击显示每位同学被抽中的概率</p>
            <p id="chanceTable" hide></p>
            <div id="chanceTableDynamicDiv" hide><table id="chanceTableDynamic"><tbody id="chanceTableDynamicBody"></tbody></table></div>
            <p>右键选择 &quot;检查&quot; 后打开控制台可查看抽取历史记录。<span id="save-line">点击<button onclick="saveFile()">保存</button>目前<strong>动态随机</strong>抽取进度 <span id="noTeachersSaved" hide>(保存时不会保存老师抽取进度)</span><span id="saveId"></strong></span></p>
        </div>
        <br />
        <p style="color: var(--gray); font-size: 20px;"><strong>- 免责声明 -</strong></p>
        <p style="color: var(--gray);">2310 班成员名单及学号根据高一下学期 3 月月考成绩单进行录入。所有同学都有同等被抽中的机会。</p>
        <p style="color: var(--gray);"><strong>真随机</strong>将会在每次抽取时从全班名单中随机选择一名同学，<strong>每次每人抽到的概率都固定</strong>。</p>
        <p style="color: var(--gray);"><strong>动态随机</strong>会根据每个人被抽到的次数对抽中的概率进行加权，<strong>被抽到次数多的人再抽到的概率将会降低</strong>。</p>
        <p class="ANT">权重: 以 16 为底数，(目前全班平均被抽到的次数 - 每个人被抽到的次数) 为指数的结果; 重抽抑制: 最近 5 个被抽到的人，权重将分别减少 90%, 80%, 70%, 50%, 20%</p>
        <p style="color: var(--gray);"><strong>伪随机</strong>将会在抽到一名同学后将其从名单中剔除，直到所有同学都被抽取过一次，<strong>确保 <span id="availableTimes" style="color: var(--gray);"></span> 次抽取中不会出现重复</strong>。</p>
        <p style="color: var(--gray);">抽人过程的动画根据目前可能抽到的同学显示，不影响最终的抽取结果。</p>
        <br />
        <h6 style="color: var(--gray);">除选人动画的音效和网页字体外，适用以下版权:</h6>
        <p style="color: var(--gray);" id="copyright"></p>
    </div>
    <script>
        copyright(2024, "Guigang JNZX 2310 XZY (千和 いのり)");
        
        const fullList = {
            all: ["徐子洋", "覃帝创", "赖宝升", "何星辉", "黄政睿", "陆格里", "杨联贵", "廖达举", "蒋子莹", "张建涛", "施奎", "黄相茗", "林峭好", "温文雅", "钟子宁", "党希琳", "杨柠豪", "吴美萍", "谢焌宇", "戴欣彤", "杨思扬", "刘乐谦", "周坤怡", "郑翼联", "黄纤媛", "黄振航", "邓家宝", "陆禹熹", "周福文", "蒋杰胜", "苏正恩", "蒙盈盈", "郑育明", "陈广榕", "廖晓雪", "黄文贝", "吴静玉", "蒙志为", "叶滨华", "邓桢", "麦诚铭", "梁瀚菲", "林思颖", "李永仲", "邱琦康", "甘永稳", "覃耀泓", "李杰", "杨凯琪", "韦国胜", "邱振鑫", "覃飞娴", "谭铮", "霍然", "练昆林"],
            boy: [],
            girl: []
        };
        let order = 0;
        
        const girlId = [9, 13, 14, 16, 18, 19, 20, 23, 25, 28, 32, 35, 36, 37, 42, 43, 47, 49, 52, 54];
        const teachers = {
            list: ["何叶", "张薇", "杨秋菊", "黄孙忠", "何琼芬", "丘仕琴", "胡兆宣", "林小玲", "甘海", "罗静", "梁泸尹"], // 蓝燕琴, 甘立德, 朱庆梅, 黄丽珊
            girlId: [56, 57, 58, 60, 61, 63, 65, 66]
        };
        
        let rollTeachers = false;

        fullList.all.forEach((_, index) => {
            if (!girlId.includes(index + 1)) {
                fullList.boy.push(fullList.all[index]);
            } else {
                fullList.girl.push(fullList.all[index]);
            }
        });

        const dynamicList = {
            times: {
                all: [],
                boy: [],
                girl: []
            },
            weight: {
                all: [],
                boy: [],
                girl: []
            },
            totalAvg: 0,
            repeatProhibit: [0, 0, 0, 0, 0]
        };
        fullList.all.forEach(() => { dynamicList.weight.all.push(1); dynamicList.times.all.push(0); });

        if (getURLparam("rollTimes") && order == 0) {
            hide("rollPanel");

            dynamicList.times.all = Array(...getURLparam("rollTimes").split(",").map(Number));
            dynamicList.times.all.forEach(rollTimes => order += rollTimes);

            dynamicList.repeatProhibit = Array(...getURLparam("repeat").split(",").map(Number));
            order--;
            updateWeight();
            order++;
            dynamicList.repeatProhibit = Array(...getURLparam("repeat").split(",").map(Number));

            const code = getURLparam("code");
            const targetVerify = seed([dynamicList.times.all, dynamicList.repeatProhibit], [code.transBase(16, 10) / 1000, code.transBase(16, 10) / 1000 - 1, code.transBase(16, 10) / 1000 - 16]);
            if (targetVerify == getURLparam("verify")) {
                unhide("readSuccess");
                copyTo("saveTime", new Date(Number(getURLparam("time"))));
                unhide("rollPanel");
            } else {
                unhide("validationInvalid");
            }
        } else {
            fullList.boy.forEach(() => { dynamicList.weight.boy.push(1); dynamicList.times.boy.push(0); });
            fullList.girl.forEach(() => { dynamicList.weight.girl.push(1); dynamicList.times.girl.push(0); });
        }

        const remainingList = fullList.isolate();
        copyTo("availableTimes", fullList.all.length);
        
        let nowRolling;
        
        let currentMode = "dynamic";
        let skipAnimation = false;
        let idNow = "";
        let chanceMode = "all";
        let showChance = false;
        let thisChance;
        
        function changeMode(mode) {
            currentMode = mode;
        
            let modeList = ["true", "dynamic", "false"];
            modeList = modeList.remove(mode);

            modeList.forEach(toHide => {
                hide(`s-${toHide}`);
            });
            unhide(`s-${mode}`);
            updateChance();
        }

        target("skipAnimation").addEventListener("change", function () {
            skipAnimation = this.checked;
        });

        target("rollTeachers").addEventListener("change", function () {
            rollTeachers = this.checked;
            if (this.checked) {
                fullList.all.push(...teachers.list);
                teachers.list.forEach(() => { dynamicList.times.all.push(0); });
                girlId.push(...teachers.girlId);

                for (let i = fullList.all.length - teachers.list.length; i < fullList.all.length; i++) {
                    if (!girlId.includes(i + 1)) {
                        fullList.boy.push(fullList.all[i]);
                        dynamicList.times.boy.push(0);
                    } else {
                        fullList.girl.push(fullList.all[i]);
                        dynamicList.times.girl.push(0);
                    }
                }
            } else {
                teachers.list.forEach(() => { fullList.all.pop(); dynamicList.times.all.pop(); });
                for (let i = 0; i < teachers.list.length - teachers.girlId.length; i++) {
                    dynamicList.times.boy.pop(); 
                }
                teachers.girlId.forEach(() => { girlId.pop(); dynamicList.times.girl.pop(); });
            }
            toggleDisplay("noTeachersSaved", this.checked, "inline");
            updateWeight(null, true);
            updateChance("all");
            confirmId();
        });

        async function roll(type) {
            applyAll("#buttonLine button, #findBySex button, #findByIdLine button", target => {
                target.disabled = true;
            });
            if (!rollTeachers) { hide("saveId"); }

            let animationList;
        
            if (type != chanceMode) { updateChance(type == "all" ? "all" : "sex"); }
        
            if (currentMode == "true") {
                nowRolling = type == "all" ? fullList.all[rand(0, fullList.all.length - 1)] : type == "boy" ? fullList.boy[rand(0, fullList.boy.length - 1)] : fullList.girl[rand(0, fullList.girl.length - 1)];
                temp = type == "all" ? { real: fullList.all.indexOf(nowRolling), classId: fullList.all.indexOf(nowRolling) + 1 }
                    : type == "boy" ? { real: fullList.boy.indexOf(nowRolling), classId: fullList.all.indexOf(nowRolling) + 1 }
                        : { real: fullList.girl.indexOf(nowRolling), classId: fullList.all.indexOf(nowRolling) + 1 };
                animationList = fullList[type];
                thisChance = 1 / fullList.all.length;
            }
            if (currentMode == "dynamic") {
                let totalWeight = 0;
                dynamicList.weight[type].forEach(weightNum => {
                    totalWeight += weightNum;
                });
            
                const selectedWeight = rand(0, totalWeight, true);
                let nowWeight = 0;
            
                let selectedPosition;
                const sumList = [];
                for (let i = 0; i < dynamicList.weight[type].length; i++) {
                    nowWeight += dynamicList.weight[type][i];
                    sumList.push(nowWeight);
                    if (nowWeight >= selectedWeight) {
                        nowRolling = fullList[type][i];
                        selectedPosition = i;
                        thisChance = dynamicList.weight[type][i] / totalWeight;
                        break;
                    }
                }
                temp = {
                    weightList: {
                        original: dynamicList.weight[type].isolate(),
                        sum: sumList,
                        result: {
                            index: sumList.length - 1,
                            classId: fullList.all.indexOf(nowRolling) + 1
                        }
                    },
                    totalWeight: totalWeight, 
                    selectedWeight: selectedWeight,
                    source: {
                        rollTimes: dynamicList.times.all,
                        totalAvg: dynamicList.totalAvg,
                        repeatProhibit: dynamicList.repeatProhibit.isolate()
                    }
                };
                animationList = fullList[type];
                updateWeight(nowRolling);
            }
            if (currentMode == "false") {
                nowRolling = type == "all" ? remainingList.all[rand(0, remainingList.all.length - 1)] : type == "boy" ? remainingList.boy[rand(0, remainingList.boy.length - 1)] : remainingList.girl[rand(0, remainingList.girl.length - 1)];
                temp = type == "all" ? { real: remainingList.all.indexOf(nowRolling), classId: fullList.all.indexOf(nowRolling) + 1, remaining: remainingList.all.isolate() }
                    : type == "boy" ? { real: remainingList.boy.indexOf(nowRolling), classId: fullList.all.indexOf(nowRolling) + 1, remaining: remainingList.boy.isolate() }
                        : { real: remainingList.girl.indexOf(nowRolling), classId: fullList.all.indexOf(nowRolling) + 1, remaining: remainingList.girl.isolate() };
                thisChance = type == "all" ? 1 / remainingList.all.length : type == "boy" ? 1 / remainingList.boy.length : 1 / remainingList.girl.length;
                animationList = fullList[type];
                animationList = remainingList[type];
            }

            const flashColor = type == "all" ? "var(--gray)" : type == "boy" ? "#88ddff" : "#ffbbbb";
            const toColor = type == "all" ? "var(--textColor-500)" : type == "boy" ? "var(--blue)" : "var(--pink)";
            if (!skipAnimation) {
                await animate(animationList, flashColor, toColor, type);
            } else {
                await animateSkip(false, toColor, type);
            }

            if (currentMode == "false") {
                remainingList.all = remainingList.all.remove(nowRolling);
                remainingList.boy = remainingList.boy.remove(nowRolling);
                remainingList.girl = remainingList.girl.remove(nowRolling);
            
                if (!remainingList.all[0]) {
                    remainingList.all = fullList.all.isolate();
                }
                if (!remainingList.boy[0]) {
                    remainingList.boy = fullList.boy.isolate();
                }
                if (!remainingList.girl[0]) {
                    remainingList.girl = fullList.girl.isolate();
                }
            }
        
            applyAll("#buttonLine button, #findBySex button", target => {
                target.disabled = false;
                fadeIn("dynamic-chance-doyouknow");
                copyTo("dynamic-chance-doyouknow", doYouKnow(thisChance, type));
                confirmId();
            });
        
            updateChance(type == "all" ? "all" : "sex");
        }

        async function animate(flashNames, flashColor, toColor, type) {
            fadeOut("dynamic-chance-doyouknow", true);
            await fadeOut("name", true);
            colorTo("name", flashColor);
            fadeIn("name");
        
            const flashTimes = currentMode == "false" && remainingList[type].length == 1 || fullList[type].length == 1 ? 0 : rand(8, 15);
            const timer = index => ((0.7 / flashTimes * index) ** 2 + 0.1 - flashTimes / 200) / 1.5;
            let lastAnimated;

            for (let i = 1; i <= flashTimes; i++) {
                const animateName = lastAnimated = flashNames.remove(lastAnimated)[rand(0, Math.max(flashNames.length - 2, 0))];
                copyTo("name", currentMode == "false" ? `${animateName} <span style="font-size: 32px;">${fullList[type].length - remainingList[type].length + 1}/${fullList[type].length}</span>` : animateName);
                playClick();
                await sleep(timer(i) * 1000);
            }

            if (lastAnimated != nowRolling) { playClick(); }
            copyTo("name", currentMode == "false" ? `${nowRolling} <span style="font-size: 32px;">${fullList[type].length - remainingList[type].length + 1}/${fullList[type].length}</span>` : nowRolling);
            await sleep(800);
            transColor("name", toColor, 200);
            logName();
        }

        async function animateSkip(isById, toColor, type) {
            await fadeOut("name", true);
            playClick();
            copyTo("name", isById ? nowRolling : currentMode == "false" ? `${nowRolling} <span style="font-size: 32px;">${fullList[type].length - remainingList[type].length + 1}/${fullList[type].length}</span>` : nowRolling);
            colorTo("name", toColor);
            fadeIn("name");
            if (!isById) { logName(); }
        }

        async function num(number) {
            if (idNow == "") {
                idNow += number;
                confirmId(number);
                copyTo("findById", "点此以取消");
                transColor("findById", "var(--red)");
            } else {
                idNow += number;
                temp = Number(idNow);
                nowRolling = `${fullList.all[Number(idNow - 1)]} <span style='font-size: 32px;'>${idNow}</span>`;
                copyTo("findById", "按学号找人");
                transColor("findById", "var(--textColor-500)");
                await animateSkip(true, "var(--textColor-500)");
                logName(1, fullList.all[Number(idNow - 1)]);
                fadeOut("dynamic-chance-doyouknow", true);
                idNow = "";
            
                confirmId();
            }
        }

        function confirmId(currentNum) {
            if (currentNum == undefined) {
                const tens = Math.ceil(fullList.all.length / 10);

                applyAll(".idButton", e => e.disabled = true);
                for (let i = 0; i < tens; i++) {
                    target(`b-${i}`).disabled = false;
                }
            } else {
                for (let i = 0; i <= 9; i++) {
                    if (fullList.all[Number(String(currentNum) + String(i)) - 1]) {
                        target(`b-${i}`).disabled = false;
                    } else {
                        target(`b-${i}`).disabled = true;
                    }
                }
            }
        }
        confirmId();

        function findByIdReset() {
            idNow = "";
            copyTo("findById", "按学号找人");
            transColor("findById", "var(--textColor-500)");
            target(`b-0`).disabled = false;
            for (let i = 6; i <= 9; i++) {
                target(`b-${i}`).disabled = true;
            }
        }

        function updateWeight(whoIsRolled, dontCycleRepeat = false) {
            dynamicList.totalAvg = (order + 1) / fullList.all.length;
        
            const rolledInAll = fullList.all.indexOf(whoIsRolled);
        
            if (rolledInAll != -1) { dynamicList.times.all[rolledInAll]++; } // Add rolled times to the people who is rolled
            dynamicList.times.boy = [];
            dynamicList.times.girl = [];
            for (let i = 0; i < dynamicList.times.all.length; i++) {
                dynamicList.times[!girlId.includes(i + 1) ? "boy" : "girl"].push(dynamicList.times.all[i]);
            }

            if (!dontCycleRepeat) {
                dynamicList.repeatProhibit.pop();
                dynamicList.repeatProhibit.unshift(fullList.all.indexOf(whoIsRolled) + 1);
            }
        
            const prohibitRatio = index => {
                const classId = index + 1;
                if (classId == dynamicList.repeatProhibit[0]) { return 0.9; }
                if (classId == dynamicList.repeatProhibit[1]) { return 0.8; }
                if (classId == dynamicList.repeatProhibit[2]) { return 0.7; }
                if (classId == dynamicList.repeatProhibit[3]) { return 0.5; }
                if (classId == dynamicList.repeatProhibit[4]) { return 0.2; }
                return 0;
            };
            const calWeight = (times, ratio) => Math.min(16 ** (dynamicList.totalAvg - times), Number.MAX_VALUE) * (1 - ratio);

            dynamicList.weight.all = dynamicList.times.all.map((times, index) => calWeight(times, prohibitRatio(index)));
            dynamicList.weight.boy = [];
            dynamicList.weight.girl = [];
            for (let i = 0; i < dynamicList.times.all.length; i++) {
                dynamicList.weight[!girlId.includes(i + 1) ? "boy" : "girl"].push(dynamicList.weight.all[i]);
            }
        }

        function playClick() {
            target("click").currentTime = 0.026;
            target("click").play();
        }

        function revealChance() {
            showChance = true;
            if (currentMode == "dynamic") {
                fadeChange("showChanceLine", "chanceTableDynamicDiv");
            } else {
                fadeChange("showChanceLine", "chanceTable");
            }
            target("name").style.marginBottom = "116px";
        }

        function updateChance(showType) {
            copyTo("chanceTable", "");
            copyTo("chanceTableDynamicBody", "");
            if (!showType) { showType = chanceMode; }
        
            if (showType == "all") {
                copyTo("chanceTable", "<span class='LNK' onclick='updateChance(\"sex\")'>切换显示按性别抽取的概率</span><br />");
                copyTo("chanceTableDynamicDiv", "<p class='LNK' onclick='updateChance(\"sex\")'>切换显示按性别抽取的概率</p><table id=\"chanceTableDynamic\"><tbody id=\"chanceTableDynamicBody\"></tbody></table><p>总权重: <strong id=\"total-weight\"></strong></p>");
                if (currentMode != "dynamic") {
                    fullList.all.forEach((name, index) => {
                        const id = index + 1;
                        addTo("chanceTable", `[${id < 10 ? `0${id}` : id}] ${name}: <span id="chance-${id < 10 ? `0${id}` : id}"></span> ${id % 10 == 0 ? `<br />` : ""}`);
                    });
                    if (showChance) {
                        unhide("chanceTable");
                        hide("chanceTableDynamicDiv");
                    }
                } else {
                    addTo("chanceTableDynamicBody", `<tr>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>概率</th>
                            <th>次数</th>
                            <th>权重</th>
                            <th>重抽抑制</th>
                            <th>|</th>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>概率</th>
                            <th>次数</th>
                            <th>权重</th>
                            <th>重抽抑制</th>
                        </tr>`);
                    const half = Math.ceil(fullList.all.length / 2);
                    fullList.all.forEach((_, index) => {
                        const id = index + 1;
                        const name1 = fullList.all[index];
                        const name2 = fullList.all[index + half];
                        if (id <= half) {
                            addTo("chanceTableDynamicBody", `<tr>
                                    <td id="d-chance-${id}-id">[${id < 10 ? `0${id}` : id}]</td>
                                    <td id="d-chance-${id}-name">${name1}</td>
                                    <th id="d-chance-${id}-chance"></th>
                                    <td id="d-chance-${id}-times"></td>
                                    <td id="d-chance-${id}-weight"></td>
                                    <td id="d-chance-${id}-repeat"></td>
                                    <td>|</td>
                                    ${id + half <= fullList.all.length ? `
                                        <td id="d-chance-${id + half}-id">[${id + half < 10 ? `0${id + half}` : id + half}]</td>
                                        <td id="d-chance-${id + half}-name">${name2}</td>
                                        <th id="d-chance-${id + half}-chance"></th>
                                        <td id="d-chance-${id + half}-times"></td>
                                        <td id="d-chance-${id + half}-weight"></td>
                                        <td id="d-chance-${id + half}-repeat"></td>`
                // eslint-disable-next-line indent
                                        : ""}
                            </tr>`);
                        }
                    });
                    if (showChance) {
                        hide("chanceTable");
                        unhide("chanceTableDynamicDiv");
                    }
                }
            
                if (currentMode == "true") {
                    for (let i = 1; i <= fullList.all.length; i++) {
                        copyTo(`chance-${i < 10 ? `0${i}` : i}`, `${(1 / fullList.all.length * 100).keep(5)}%`);
                    }
                }
                if (currentMode == "dynamic") {
                    let totalWeight = 0;
                    dynamicList.weight.all.forEach(weightNum => {
                        totalWeight += weightNum;
                    });
                    copyTo("total-weight", totalWeight.keep(3));

                    const getColor = value => {
                        const total = fullList.all.length;

                        if (value == 0) {
                            return 130;
                        }
                        if (value.range(0, 50 / total)) {
                            return Math.log10(value).percentage(-1, Math.log10(50 / total)).transit(130, 100);
                        }
                        if (value.range(50 / total, 100 / total)) {
                            return value.percentage(50 / total, 100 / total).transit(100, 70);
                        }
                        return value.percentage(100 / total, 8).transit(70, 0);
                    };

                    dynamicList.weight.all.forEach((weightNum, index) => {
                        const i = index + 1;

                        const chance = (weightNum / totalWeight * 100).keep(5);
                        copyTo(`d-chance-${i}-chance`, `${chance < 1e-5 ? "<0.00001" : chance}%`);

                        colorTo(`d-chance-${i}-chance`, `hsl(${getColor(chance)}, 100%, 45%)`);

                        copyTo(`d-chance-${i}-times`, dynamicList.times.all[index]);
                        copyTo(`d-chance-${i}-weight`, dynamicList.weight.all[index].keep(3));

                        copyTo(`d-chance-${i}-repeat`, "0%");
                        colorTo(`d-chance-${i}-repeat`, "var(--textColor-500)");
                        colorTo(`d-chance-${i}-weight`, "var(--textColor-500)");
                        if (i == dynamicList.repeatProhibit[4]) { copyTo(`d-chance-${i}-repeat`, "-20%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-5)"); colorTo(`d-chance-${i}-weight`, "var(--tier-5)"); }
                        if (i == dynamicList.repeatProhibit[3]) { copyTo(`d-chance-${i}-repeat`, "-50%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-4)"); colorTo(`d-chance-${i}-weight`, "var(--tier-4)"); }
                        if (i == dynamicList.repeatProhibit[2]) { copyTo(`d-chance-${i}-repeat`, "-70%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-3)"); colorTo(`d-chance-${i}-weight`, "var(--tier-3)"); }
                        if (i == dynamicList.repeatProhibit[1]) { copyTo(`d-chance-${i}-repeat`, "-80%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-2)"); colorTo(`d-chance-${i}-weight`, "var(--tier-2)"); }
                        if (i == dynamicList.repeatProhibit[0]) { copyTo(`d-chance-${i}-repeat`, "-90%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-1)"); colorTo(`d-chance-${i}-weight`, "var(--tier-1)"); }
                    });
                }
                if (currentMode == "false") {
                    const nowLeftChance = 1 / remainingList.all.length;
                    for (let i = 1; i <= fullList.all.length; i++) {
                        if (remainingList.all.includes(fullList.all[i - 1])) {
                            copyTo(`chance-${i < 10 ? `0${i}` : i}`, `${(nowLeftChance * 100).keep(5)}%`);
                        } else {
                            copyTo(`chance-${i < 10 ? `0${i}` : i}`, `0%`);
                        }
                    }
                }
            } else { // Show chance rolled by sex
                copyTo("chanceTable", "<span class='LNK' onclick='updateChance(\"all\")'>切换显示全班抽取的概率</span><br />");
                copyTo("chanceTableDynamicDiv", "<p class='LNK' onclick='updateChance(\"all\")'>切换显示全班抽取的概率</p><table id=\"chanceTableDynamic\"><tbody id=\"chanceTableDynamicBody\"></tbody></table><p>总权重: <strong id=\"total-weight\"></strong></p>");
                if (currentMode != "dynamic") {
                    fullList.all.forEach((name, index) => {
                        const id = index + 1;
                        addTo("chanceTable", `[${id < 10 ? `0${id}` : id}] ${name}: <span id="chance-${id < 10 ? `0${id}` : id}"></span> ${id % 10 == 0 ? `<br />` : ""}`);
                    });
                    if (showChance) {
                        unhide("chanceTable");
                        hide("chanceTableDynamicDiv");
                    }
                } else {
                    addTo("chanceTableDynamicBody", `<tr>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>概率</th>
                            <th>次数</th>
                            <th>权重</th>
                            <th>重抽抑制</th>
                            <th>|</th>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>概率</th>
                            <th>次数</th>
                            <th>权重</th>
                            <th>重抽抑制</th>
                        </tr>`);
                    const half = Math.ceil(fullList.all.length / 2);
                    fullList.all.forEach((_, index) => {
                        const id = index + 1;
                        const name1 = fullList.all[index];
                        const name2 = fullList.all[index + half];
                        if (id <= half) {
                            addTo("chanceTableDynamicBody", `<tr>
                                    <td id="d-chance-${id}-id">[${id < 10 ? `0${id}` : id}]</td>
                                    <td id="d-chance-${id}-name">${name1}</td>
                                    <th id="d-chance-${id}-chance"></th>
                                    <td id="d-chance-${id}-times"></td>
                                    <td id="d-chance-${id}-weight"></td>
                                    <td id="d-chance-${id}-repeat"></td>
                                    <td>|</td>
                                    ${id + half <= fullList.all.length ? `
                                        <td id="d-chance-${id + half}-id">[${id + half < 10 ? `0${id + half}` : id + half}]</td>
                                        <td id="d-chance-${id + half}-name">${name2}</td>
                                        <th id="d-chance-${id + half}-chance"></th>
                                        <td id="d-chance-${id + half}-times"></td>
                                        <td id="d-chance-${id + half}-weight"></td>
                                        <td id="d-chance-${id + half}-repeat"></td>`
                // eslint-disable-next-line indent
                                        : ""}
                            </tr>`);
                        }
                    });
                    if (showChance) {
                        hide("chanceTable");
                        unhide("chanceTableDynamicDiv");
                    }
                }
            
                if (currentMode == "true") {
                    for (let i = 1; i <= fullList.all.length; i++) {
                        copyTo(`chance-${i < 10 ? `0${i}` : i}`, `${(1 / fullList[!girlId.includes(i) ? "boy" : "girl"].length * 100).keep(5)}%`);
                        colorTo(`chance-${i < 10 ? `0${i}` : i}`, !girlId.includes(i) ? "var(--blue)" : "var(--pink)");
                    }
                }
                if (currentMode == "dynamic") {
                    const totalWeight = {
                        boy: 0,
                        girl: 0
                    };
                    dynamicList.weight.boy.forEach(weightNum => {
                        totalWeight.boy += weightNum;
                    });
                    dynamicList.weight.girl.forEach(weightNum => {
                        totalWeight.girl += weightNum;
                    });
                    copyTo("total-weight", `<span style="color: var(--blue)">${totalWeight.boy.keep(3)}</span> / <span style="color: var(--pink)">${totalWeight.girl.keep(3)}</span>`);

                    dynamicList.weight.all.forEach((weightNum, index) => {
                        const i = index + 1;
                        const boyGirlIndex = fullList.boy.indexOf(fullList.all[index]) != -1 ? fullList.boy.indexOf(fullList.all[index]) : fullList.girl.indexOf(fullList.all[index]);

                        const chance = (weightNum / totalWeight[!girlId.includes(index + 1) ? "boy" : "girl"] * 100).keep(5);
                        copyTo(`d-chance-${i}-chance`, `${chance < 1e-5 ? "<0.00001" : chance}%`);
                        colorTo(`d-chance-${i}-chance`, !girlId.includes(index + 1) ? "var(--blue)" : "var(--pink)");

                        copyTo(`d-chance-${i}-times`, dynamicList.times[!girlId.includes(index + 1) ? "boy" : "girl"][boyGirlIndex]);
                        copyTo(`d-chance-${i}-weight`, dynamicList.weight[!girlId.includes(index + 1) ? "boy" : "girl"][boyGirlIndex].keep(3));

                        copyTo(`d-chance-${i}-repeat`, "0%");
                        if (i == dynamicList.repeatProhibit[4]) { copyTo(`d-chance-${i}-repeat`, "-20%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-5)"); colorTo(`d-chance-${i}-weight`, "var(--tier-5)"); }
                        if (i == dynamicList.repeatProhibit[3]) { copyTo(`d-chance-${i}-repeat`, "-50%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-4)"); colorTo(`d-chance-${i}-weight`, "var(--tier-4)"); }
                        if (i == dynamicList.repeatProhibit[2]) { copyTo(`d-chance-${i}-repeat`, "-70%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-3)"); colorTo(`d-chance-${i}-weight`, "var(--tier-3)"); }
                        if (i == dynamicList.repeatProhibit[1]) { copyTo(`d-chance-${i}-repeat`, "-80%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-2)"); colorTo(`d-chance-${i}-weight`, "var(--tier-2)"); }
                        if (i == dynamicList.repeatProhibit[0]) { copyTo(`d-chance-${i}-repeat`, "-90%"); colorTo(`d-chance-${i}-repeat`, "var(--tier-1)"); colorTo(`d-chance-${i}-weight`, "var(--tier-1)"); }
                    });
                }
                if (currentMode == "false") {
                    for (let i = 1; i <= fullList.all.length; i++) {
                        const nowLeftChance = 1 / remainingList[!girlId.includes(i) ? "boy" : "girl"].length;
                        if (remainingList[!girlId.includes(i) ? "boy" : "girl"].includes(fullList.all[i - 1])) {
                            copyTo(`chance-${i < 10 ? `0${i}` : i}`, `${(nowLeftChance * 100).keep(5)}%`);
                        } else {
                            copyTo(`chance-${i < 10 ? `0${i}` : i}`, `0%`);
                        }
                        colorTo(`chance-${i < 10 ? `0${i}` : i}`, !girlId.includes(i) ? "var(--blue)" : "var(--pink)");
                    }
                }
            }
        
            chanceMode = showType;
        }
        updateChance("all");

        function cr(id) {
            if (fullList.all[id - 1]) {
                updateWeight(fullList.all[id - 1]);
                updateChance(chanceMode == "all" ? "all" : "sex");
                logName(2, fullList.all[id - 1], id);
            } else {
                throw new ReferenceError(`No ID ${id} target found`);
            }
        }

        function doYouKnow(chance, type) {
            const chancePercent = (chance * 100).keep(5);
            const close = 1.2;

            let startSentence = `抽中 ${nowRolling} 的概率为 <strong style="color: ${type == "all" ? chancePercent <= 0.6 * close ? "var(--lightOrange)" : "var(--textColor-500)" : type == "boy" ? "var(--blue)" : "var(--pink)"}">${chancePercent == 0 ? `&lt; 0.00001` : chancePercent}%</strong>`;
            colorTo("dynamic-chance-doyouknow", "var(--textColor-500)");

            if (chancePercent == 0) {
                colorTo("dynamic-chance-doyouknow", "var(--lightOrange)");
                return startSentence;
            }

            if (chancePercent <= 0.256) {
                colorTo("dynamic-chance-doyouknow", "var(--lightOrange)");
                if (chancePercent.range(0.128, 0.256)) {
                    return startSentence += ": <strong>小于</strong> CS2 单抽出金概率";
                }
                const nearestCoinProbability = function (targetProbability) {
                    let n = 0;
                    let currentProbability = 1;
                    while (Math.abs(currentProbability - targetProbability) > Math.abs(currentProbability / 2 - targetProbability)) {
                        n++;
                        currentProbability /= 2;
                    }
                    return n;
                };
                return startSentence += `: <strong>小于</strong> CS2 单抽出金概率, 约为硬币<strong>连续 ${nearestCoinProbability(chancePercent / 100)} 次正面</strong>概率`;
            }
            if (chancePercent <= 0.256 * close) {
                colorTo("dynamic-chance-doyouknow", "var(--lightOrange)");
                return startSentence += ": 接近 CS2 单抽出金概率";
            }

            if (chancePercent <= 0.6) {
                colorTo("dynamic-chance-doyouknow", "var(--lightOrange)");
                return startSentence += ": <strong>小于</strong>原神单抽出金概率";
            }
            if (chancePercent <= 0.6 * close) {
                colorTo("dynamic-chance-doyouknow", "var(--lightOrange)");
                return startSentence += ": 接近原神单抽出金概率";
            }
            if (chancePercent.range(0.6 * close, 1)) {
                return startSentence += ": 约为连续抛出硬币正面 7 次概率";
            }

            // 

            if (chancePercent.range(20, 40)) {
                return startSentence += ": 约为单选题蒙对概率";
            }
            if (chancePercent.range(40, 60)) {
                return startSentence += ": 约为硬币抛出背面概率";
            }

            return startSentence;
        }

        function logName(mode, p2, p3) {
            if (mode == 0 || mode == undefined) { // Default
                log(++order, nowRolling, currentMode.toUpperCase(), chanceMode == "all" ? "ALL" : target("name").style.color == "var(--blue)" ? "BOY" : "GIRL", temp, skipAnimation ? "SKIPPED" : "NO-SKIP", !rollTeachers ? "STUDENT" : "TEACHER");
            }
            if (mode == 1) { // By ID
                log(++order, p2, "BY-ID", temp, skipAnimation ? "SKIPPED" : "NO-SKIP", !rollTeachers ? "STUDENT" : "TEACHER");
            }
            if (mode == 2) { // Console Roll
                log(++order, p2, "CONSOLE", p3, skipAnimation ? "SKIPPED" : "NO-SKIP", !rollTeachers ? "STUDENT" : "TEACHER");
            }
        }

        log(`关于随机抽人历史记录的解读
第 1 位: 抽取次数 (从 1 开始)
第 2 位: 抽到的人
第 3 位: 抽取方式: 'TRUE' 真随机; 'DYNAMIC' 动态随机; 'FALSE' 伪随机; 'BY-ID' 按学号找人; 'CONSOLE' 控制台抽取
第 4 位 ('BY-ID' 没有此项): 抽取范围: 'ALL' 全体; 'BOY' 男生; 'GIRL' 女生
第 5 位: 抽取信息 (注意 JavaScript 中计数从 0 开始，所以下面部分数据会有 1 的差距)
  真随机: classId: 抽到的人的学号; real: 电脑真正随机到的数字
  动态随机: selectWeight: 随机到的权重; totalWeight: 抽取范围内总权重; weightList: { original: 原始权重表; result: { index: 第一个累计权重大于随即权重的序号; classId: 该序号对应的人的学号 } sum: 累计权重表 }
  伪随机: classId: 抽到的人的学号; real: 电脑真正随机到的数字; remaining: 抽取时的抽取范围 (剩余人员列表)
  按学号找人/控制台抽取: 学号
第 6 位: 抽取时是否跳过了动画: 'NO-SKIP' 未跳过; 'SKIPPED' 跳过
第 7 位: 抽取范围是否包括科任老师: 'STUDENT' 仅学生; 'TEACHER' 包括老师`);

        function saveFile() {
            const id = rand(0, 0xffff);
            const idHex = id.toBase(16).padStart(4, "0");
            const saveInfo = {
                rollTimes: dynamicList.times.all.slice(0, 56),
                repeatProhibit: dynamicList.repeatProhibit.map(x => x <= fullList.all.length - (rollTeachers ? teachers.list.length : 0) ? x : 0)
            };
            const verify = seed([saveInfo.rollTimes, saveInfo.repeatProhibit], [id / 1000, id / 1000 - 1, id / 1000 - 16]);

            // eslint-disable-next-line no-useless-escape
            save(`2310 班随机选人_${idHex}.html`, `<p>正在加载 2310 班随机选人，请稍等...</p><script>window.location.href = '${host()}/?rollTimes=${saveInfo.rollTimes}&repeat=${saveInfo.repeatProhibit}&code=${idHex}&time=${new Date().getTime()}&verify=${verify}';<\/script>`);
            unhide("saveId", "inline");
            copyTo("saveId", `保存代码: <strong>${idHex}</strong>`);
        }

        // BIRTH 2310

        const birthList = [["徐子洋", 2007, 12, 12], ["覃帝创", 2008, 2, 23], ["赖宝升", 2007, 9, 24], ["何星辉", 2007, 10, 11], ["黄政睿", 2007, 7, 29], ["陆格里", 2007, 11, 2], ["杨联贵", 2008, 1, 24], ["廖达举", 2007, 11, 24], ["蒋子莹", 2008, 7, 30], ["张建涛", 2008, 7, 4], ["施奎", 2007, 11, 11], ["黄相茗", 2007, 9, 12], ["林峭好", 2008, 1, 17], ["温文雅", 2007, 6, 19], ["钟子宁", 2007, 10, 7], ["党希琳", 2008, 4, 9], ["杨柠豪", 2008, 6, 22], ["吴美萍", 2007, 11, 22], ["谢焌宇", 2008, 12, 10], ["戴欣彤", 2007, 10, 6], ["杨思扬", 2007, 8, 8], ["刘乐谦", 2007, 10, 9], ["周坤怡", 2007, 7, 17], ["郑翼联", 2007, 8, 12], ["黄纤媛", 2007, 12, 27], ["黄振航", 2007, 11, 2], ["邓家宝", 2008, 2, 9], ["陆禹熹", 2007, 11, 30], ["周福文", 2007, 6, 17], ["蒋杰胜", 2008, 8, 28], ["苏正恩", 2007, 11, 12], ["蒙盈盈", 2008, 6, 10], ["郑育明", 2007, 8, 14], ["陈广榕", 2008, 6, 27], ["廖晓雪", 2007, 7, 31], ["黄文贝", 2008, 2, 7], ["吴静玉", 2007, 10, 17], ["蒙志为", 2008, 3, 31], ["叶滨华", 2007, 10, 18], ["邓桢", 2008, 6, 9], ["麦诚铭", 2008, 3, 1], ["梁瀚菲", 2008, 8, 22], ["林思颖", 2007, 11, 4], ["李永仲", 2008, 10, 5], ["邱琦康", 2007, 3, 16], ["甘永稳", 2007, 12, 11], ["覃耀泓", 2007, 8, 20], ["李杰", 2008, 6, 22], ["杨凯琪", 2007, 6, 3], ["韦国胜", 2008, 3, 13], ["邱振鑫", 2008, 3, 8], ["覃飞娴", 2007, 11, 13], ["谭铮", 2007, 9, 30], ["霍然", 2007, 8, 14], ["练昆林", 2008, 4, 30]];
        const toBirth = [];
        
        function getDaysLeft(year, month, day) {
            const targetDate = new Date(year, month - 1, day);
            const currentDate = new Date();

            currentDate.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);

            const timeDifference = targetDate - currentDate;
            const daysDifference = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));

            return daysDifference;
        }

        birthList.forEach(element => {
            let nextBirthYear = element[1];

            while (getDaysLeft(nextBirthYear, element[2], element[3]) < 0) {
                nextBirthYear++;
            }
            element.push(nextBirthYear);
            toBirth.push(getDaysLeft(nextBirthYear, element[2], element[3]));
        });

        for (let i = 0; i <= 366; i++) {
            let triggered;

            while (toBirth.indexOf(i) >= 0) {
                const index = toBirth.indexOf(i);
                const isToday = i == 0;
                const target = {
                    name: birthList[index][0],
                    birth: `${birthList[index][1]}.${birthList[index][2]}.${birthList[index][3]}`,
                    age: birthList[index][4] - birthList[index][1]
                };

                addTo("nextBirthday", `<p ${isToday ? "style='color: var(--green); font-weight: 900; font-size: 32px;'>&gt; 今天生日: " : ">下一个生日: "}${target.name} ${target.birth} (${toBirth[index] == 0 ? "今" : `${toBirth[index]} `}天 -&gt; ${target.age} 岁)${isToday ? " &lt;" : ""}</p>`);

                toBirth[index] = -1;
                triggered = true;
            }

            if (triggered) { break; }
        }
    </script>
</div></body>

</html>