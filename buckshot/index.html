<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>恶魔轮盘 子弹记录 - ChiwaInori.top</title>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/type-normal.css" />
    <style>
        :root {
            --live: #ff7c7c;
            --blank: var(--textColor-500);
            --unknown: var(--textColor-400);
            --convert: #007700;
        }

        #select-live span {
            color: var(--gray);
        }

        .telephoneHintsGroup h6 {
            color: var(--textColor-400);
        }

        .shootButton {
            width: 256px;
        }

        .normalButton {
            height: 256px;
        }

        .convertButton {
            height: 96px;
        }
    </style>
    <script src="/chiwa-functions.js"></script>
</head>

<body><div class="mainBody">
    <div class="title">
        <h1>恶魔轮盘 子弹记录</h1>
    </div>
    <div class="navigation">
        <h6><a href="../">ChiwaInori.top</a> &gt; <strong>恶魔轮盘 子弹记录</strong></h6>
    </div>
    <div class="content">
        <div id="welcome">
            <div id="startTxt">
                <p>此页面可以帮助你记下 <a href="https://store.steampowered.com/app/2835570/" target="_blank">恶魔轮盘 (Buckshot Roulette)</a> 中的子弹情况。</p>
                <p>本页面同样适用于多人模式。</p>
                <br />
            </div>
            <p>在开始前，请确认子弹类型及数量。</p>
            <div id="select-live-div">
                <p><strong>选择 <span style="color: var(--live);">实弹</span> 数量:</strong></p>
                <p><strong id="select-live"><span onclick="chooseLive(1)">&nbsp;[1]&nbsp;</span><span onclick="chooseLive(2)">&nbsp;[2]&nbsp;</span><span onclick="chooseLive(3)">&nbsp;[3]&nbsp;</span><span onclick="chooseLive(4)">&nbsp;[4]&nbsp;</span><span onclick="chooseLive(5)">&nbsp;[5]&nbsp;</span><span onclick="chooseLive(6)">&nbsp;[6]&nbsp;</span><span onclick="chooseLive(7)">&nbsp;[7]&nbsp;</span><span onclick="chooseLive(8)">&nbsp;[8]&nbsp;</span><span onclick="chooseLive(9)">&nbsp;[9]&nbsp;</span><span>&nbsp;[-]&nbsp;</span></strong></p>
            </div>
            <div id="select-blank-div" hidden>
                <p><strong>选择 <span style="color: var(--blank);">空弹</span> 数量:</strong></p>
                <p><strong id="select-blank"></strong></p>
                <p><strong id="select-blank-final"></strong></p>
            </div>
        </div>
        <div id="gamePhase" hidden>
            <p>子弹已装填 - 请在你 / 庄家 (其他玩家) 每次射击 / 喝酒后，按下下方相应的按钮。</p>
            <p><img src="./Live_Shell.webp" width="32" style="display: inline;" />&nbsp;&nbsp;<span style="color: var(--live); font-size: 22px;"><strong>实弹</strong></span>&nbsp;&nbsp;<strong><span id="liveCountTxt" style="font-size: 32px; color: var(--live);"></span></strong></p>
            <p><img src="./Blank_Shell.webp" width="32" style="display: inline;" />&nbsp;&nbsp;<span style="font-size: 22px;"><strong>空弹</strong></span>&nbsp;&nbsp;<strong><span id="blankCountTxt" style="font-size: 32px;"></span></strong></p>
            <h2>下一次射击: <span style="color: var(--live)">实 <span id="liveChance" style="color: var(--live)"></span>%<span style="color: var(--textColor-400);"> <span id="advantage-live"></span><span id="advantage-blank"></span> </span><span>空 <span id="blankChance"></span>% <span id="confirmed" style="display: none;">(已通过电话确认)</span><span id="changed" style="color: #aaaaaa; display: none;">(电话已更改概率)</span></h3>
            <h4>子弹顺序: <strong id="bulletLine"></strong></h4>
            <h5>
                电话: 第
                <select id="telephoneOrder">

                </select>
                发子弹 ... &lt;<input type="radio" name="telephoneType" id="telephoneLive" type="checkbox" style="margin-left: 0px;" checked="true" /><span style="color: var(--live)">实</span> / <input type="radio" name="telephoneType" id="telephoneBlank" type="checkbox" style="margin-left: 0px;" />空&gt; 弹。<button id="telephoneButton" onclick="telephone()">确认</button></h5>
            <div id="telephoneHintsGroup"></div>
            <br />
            <h4><span style="margin-left: 128px; margin-right: 128px; color: var(--live);">实弹</span><span style="margin-left: 128px; margin-right: 128px;">空弹</span></h4>
            <h4>常规发射</h4>
            <p><button id="shootNormalLive" class="shootButton liveButton normalButton" onclick="shoot(1)">常规发射 | <span style="color: var(--live);">实弹</span></button>
            <button id="shootNormalBlank" class="shootButton blankButton normalButton" onclick="shoot(2)">常规发射 | <span style="color: var(--blank)">空弹</span></button></p>
            <br />
            <h4 style="color: #007700;">使用转换器</h4>
            <h6>* 注: 对于两个 &quot;<span style="color: #007700;">使用转换器</span>&quot; 的按钮，根据发射出的实际子弹类型选择 <span style="color: var(--live);">实弹</span> 或 空弹，而不是选择转换前的类型。</h6>
            <p><button id="shootInvertLive" class="shootButton blankButton convertButton" onclick="shoot(3)"><span style="color: var(--convert);">使用转换器</span> | <span style="color: var(--live);">实弹</span></button>
            <button id="shootInvertBlank" class="shootButton liveButton convertButton" onclick="shoot(4)"><span style="color: var(--convert);">使用转换器</span> | <span style="color: var(--blank)">空弹</span></button></p>
        </div>
    </div>
    <script>
        const bullets = {
            total: 0,
            left: {
                live: 0,
                blank: 0
            },
            telephoneModified: {}
        };
        const telephoneHints = {};
        let nowRound = 0;

        function updateStartButton() {
            const liveCount = Number(cws("#liveCount").value);
            const blankCount = Number(cws("#blankCount").value);
            if (liveCount >= 0 && blankCount >= 0 && liveCount + blankCount >= 1) {
                cws("#startButton").el.disabled = false;
            }
        }

        function start() {
            bullets.total = bullets.left.live + bullets.left.blank;
            bullets.telephoneModified = bullets.left.isolate();

            fadeChange("welcome", "gamePhase");
            cws("#liveCountTxt").unhide("inline");
            cws("#blankCountTxt").unhide("inline");
            cws("#liveCountTxt").html = bullets.left.live;
            cws("#blankCountTxt").html = bullets.left.blank;

            generateLine();
            shoot(0);
        }

        function shoot(type) {
            applyAll(".shootButton", element => element.disabled = false);
            
            if (type == 1) { bullets.left.live--; updateLine("live", false); }
            if (type == 2) { bullets.left.blank--; updateLine("blank", false); }
            if (type == 3) { bullets.left.blank--; updateLine("blank", true); }
            if (type == 4) { bullets.left.live--; updateLine("live", true); }
            
            nowRound++;
            const revealed = nowRound in telephoneHints;
            if (!(nowRound - 1 in telephoneHints)) {
                if (type == 1 || type == 4) { bullets.telephoneModified.live--; }
                if (type == 2 || type == 3) { bullets.telephoneModified.blank--; }
            }
            if (nowRound in telephoneHints) {
                cws(`#hint-${nowRound}`).color = "var(--red)";
            }

            if (nowRound >= 2 && cws(`#hint-${nowRound - 1}`).el) {
                cws(`#hint-${nowRound - 1}`).color = "var(--textColor-400)";
            }

            if (bullets.left.live != 0) {
                cws("#liveCountTxt").html = bullets.left.live;
            } else {
                cws("#liveCountTxt").html = "已打完";
                cws("#liveCountTxt").color = "#dd0000";
                cws("#shootNormalLive").el.disabled = cws("#shootInvertBlank").el.disabled = true;

                for (let i = nowRound; i <= bullets.total; i++) {
                    cws(`#line-${i}`).color = `var(--blank)`;
                }
            }

            if (bullets.left.blank != 0) {
                cws("#blankCountTxt").html = bullets.left.blank;
            } else {
                cws("#blankCountTxt").html = "已打完";
                cws("#blankCountTxt").color = "#dd0000";
                cws("#shootInvertLive").el.disabled = cws("#shootNormalBlank").el.disabled = true;

                for (let i = nowRound; i <= bullets.total; i++) {
                    cws(`#line-${i}`).color = `var(--live)`;
                }
            }
            
            updateChance(revealed);
        }

        function telephone() {
            const orderId = Number(cws("#telephoneOrder").value);
            const absoluteId = orderId + nowRound - 1;
            const isLive = cws("#telephoneLive").el.checked;

            telephoneHints[absoluteId] = isLive;
            if (isLive) {
                bullets.telephoneModified.live--;
            } else {
                bullets.telephoneModified.blank--;
            }

            cws("#telephoneOrder").value = "";
            cws("#telephoneHintsGroup").html += `<h6 style="color: var(--textColor-400);">本局第 <span id="hint-${absoluteId}" style="color: var(--blank);">${absoluteId}</span> 发: ${isLive ? "<span style='color: var(--live);'>实弹</span>" : "<span style='color: var(--blank);'>空弹</span>"}</h6>`;
            cws(`#line-${absoluteId}`).color = `var(--${isLive ? "live" : "blank"})`;
            updateChance(nowRound in telephoneHints);
        }

        function updateChance(revealed) {
            let liveChance;
            const noLeft = bullets.telephoneModified.live != 0 || bullets.telephoneModified.blank != 0;

            if (revealed) {
                const isLive = telephoneHints[nowRound];
                liveChance = isLive ? 100 : 0;
                cws("#confirmed").color = `var(--${isLive ? "live" : "blank"})`;
            } else {
                const bulletsLeft = bullets.telephoneModified.live + bullets.telephoneModified.blank;
                liveChance = noLeft ? parseInt(bullets.telephoneModified.live / bulletsLeft * 100) : 0;
            }
            const blankChance = bullets.left.live + bullets.left.blank != 0 ? 100 - liveChance : 0;

            cws("#liveChance").html = liveChance;
            cws("#blankChance").html = blankChance;
            if (revealed) { cws("#confirmed").unhide("inline"); } else { cws("#confirmed", "id").hide(); }

            cws("#advantage-live").html = liveChance >= blankChance ? "<" : "|";
            cws("#advantage-live").color = liveChance >= blankChance ? "var(--lightOrange)" : "var(--gray)";
            cws("#advantage-blank").html = liveChance < blankChance ? ">" : "|";
            cws("#advantage-blank").color = liveChance < blankChance ? "var(--lightOrange)" : "var(--gray)";

            if (liveChance == 100) {
                cws("#shootInvertLive").el.disabled = true;
                cws("#shootNormalBlank").el.disabled = true;

                cws("#advantage-live").html = "<";
                cws("#advantage-live").color = "var(--green)";
                cws("#advantage-blank").html = "|";
                cws("#advantage-blank").color = "var(--gray)";
            }
            if (blankChance == 100) {
                cws("#shootInvertBlank").el.disabled = true;
                cws("#shootNormalLive").el.disabled = true;

                cws("#advantage-live").html = "|";
                cws("#advantage-live").color = "var(--gray)";
                cws("#advantage-blank").html = ">";
                cws("#advantage-blank").color = "var(--green)";
            }
            if (liveChance == 0 && blankChance == 0) {
                cws("#advantage-live").html = "|";
                cws("#advantage-live").color = "var(--gray)";
                cws("#advantage-blank").html = "|";
                cws("#advantage-blank").color = "var(--gray)";
            }

            const chanceModified = bullets.left.live != bullets.telephoneModified.live || bullets.left.blank != bullets.telephoneModified.blank;
            if (chanceModified && !revealed) { cws("#changed").unhide("inline"); } else { cws("#changed", "id").hide(); }

            if (bullets.telephoneModified.live == 0) {
                for (let i = 1; i <= bullets.total; i++) {
                    if (cws(`#line-${i}`).el.style.color == "var(--unknown)") { cws(`#line-${i}`).color = "var(--blank)"; }
                }
            }
            if (bullets.telephoneModified.blank == 0) {
                for (let i = 1; i <= bullets.total; i++) {
                    if (cws(`#line-${i}`).el.style.color == "var(--unknown)") { cws(`#line-${i}`).color = "var(--live)"; }
                }
            }

            cws("#telephoneOrder").html = "";
            cws("#telephoneButton").el.disabled = true;
            for (let i = 2; i <= bullets.left.live + bullets.left.blank; i++) {
                if (!(i + nowRound - 1 in telephoneHints)) {
                    cws("#telephoneOrder").html += `<option value="${i}">${i}</option>`;
                    cws("#telephoneButton").el.disabled = false;
                }
            }
        }

        function generateLine() {
            for (let i = 1; i <= bullets.total; i++) {
                cws("#bulletLine").html += `<span id="line-${i}">[${i}]</span>&nbsp;`;
                cws(`#line-${i}`).color = "var(--unknown)";
            }
            cws("#line-1").html = `<ruby>${cws("#line-1").html}<rt style="color: var(--red)">NEXT</rt></ruby>`;
        }

        function updateLine(type, converted) {
            cws(`#line-${nowRound}`).color = `var(--${type})`;
            if (converted) { cws(`#line-${nowRound}`).html += `<span style="color: var(--convert)">&gt;!</span>`; }

            cws("#bulletLine").html = cws("#bulletLine").html.replaceAll(/NEXT/g, "");
            if (nowRound + 1 <= bullets.total) {
                cws(`#line-${nowRound + 1}`).html = `<ruby>${cws(`#line-${nowRound + 1}`).html}<rt style="color: var(--red)">NEXT</rt></ruby>`;
            } else {
                cws("#bulletLine").html += "<span style='color: var(--green);'>&lt;FIN&gt;</span>";
            }
        }

        function chooseLive(count) {
            bullets.left.live = count;

            for (let i = 1; i <= count - 1; i++) {
                cws("#select-blank").html += `<span style="color: var(--live)">&nbsp;[-]&nbsp;</span>`;
            }
            cws("#select-blank").html += `<span style="color: var(--live)">&nbsp;[${count}]&nbsp;</span>`;
            for (let i = count + 1; i <= 10; i++) {
                cws("#select-blank").html += `<span style="color: var(--gray)" onclick="chooseBlank(${i - count})">&nbsp;[${i - count}]&nbsp;</span>`;
            }

            cws("#select-live-div").hide();
            cws("#select-blank-div").unhide();
        }

        function chooseBlank(count) {
            bullets.left.blank = count;

            for (let i = 1; i <= bullets.left.live - 1; i++) {
                cws("#select-blank-final").html += `<span style="color: var(--live)">&nbsp;[-]&nbsp;</span>`;
            }
            cws("#select-blank-final").html += `<span style="color: var(--live)">&nbsp;[${bullets.left.live}]&nbsp;</span>`;
            for (let i = bullets.left.live + 1; i <= bullets.left.live + bullets.left.blank - 1; i++) {
                cws("#select-blank-final").html += `<span style="color: var(--blank)">&nbsp;[-]&nbsp;</span>`;
            }
            cws("#select-blank-final").html += `<span style="color: var(--blank)">&nbsp;[${bullets.left.blank}]&nbsp;</span>`;
            for (let i = bullets.left.live + bullets.left.blank + 1; i <= 10; i++) {
                cws("#select-blank-final").html += `<span style="color: var(--gray)">&nbsp;[-]&nbsp;</span>`;
            }

            cws("#select-blank").hide();
            cws("#select-blank-final").unhide();
            
            start();
        }
    </script>
</div></body>

</html>